# Story 2.1: Implement Advanced Preprocessing and OCR Layer

## Status
Draft

## Story
**As a** System Administrator/Backend Process,
**I want** to automatically detect if a CV is text-based or image-based, and process it through an appropriate pathway (standard text extraction or a new OCR service),
**So that** all uploaded CVs, regardless of format, can be accurately converted into raw text for the next stage of the AI analysis pipeline.

## Acceptance Criteria
1. The system can successfully extract text from structured PDF and DOCX files using the existing or enhanced text extraction logic, handling both Vietnamese and English structural keywords for section splitting.
2. The system can accurately detect unstructured/scanned CV files and automatically route them to a newly implemented OCR processing pathway.
3. The OCR pathway successfully extracts readable and comprehensive text content from image-based or unstructured CVs.
4. The `robust_section_split` logic for text extraction is robust for both Vietnamese and English language CVs.
5. The `cv/service.py` intelligently directs CVs to either the standard text extraction or the new OCR pathway based on an internal file analysis mechanism.
6. Existing functionality related to CV upload, storage, and initial processing (prior to AI analysis) continues to work as expected without any regression.
7. The new OCR component is successfully integrated into the `ai` module, allowing for its invocation and execution.
8. The quality of text extracted via the new OCR pathway or the enhanced `robust_section_split` is high enough to enable effective subsequent AI analysis.
9. Appropriate unit and integration tests are developed and pass for the new OCR pathway, the file routing logic, and the enhanced text extraction.
10. No regression in existing functionality is introduced by these changes, verified through a comprehensive testing suite.

## Tasks / Subtasks
- [ ] **Task 1: Enhance `cv.service` for CV Routing (AC: 2, 5)**
    - [ ] In `backend/app/modules/cv/service.py`, modify the `create_cv` (or similar) function to include a pre-processing step.
    - [ ] Implement a heuristic to detect if a file is image-based (e.g., attempt text extraction, if it fails or returns minimal/garbled text, flag for OCR).
    - [ ] Based on the heuristic, call either the existing text extraction logic or trigger the new OCR background task.
- [ ] **Task 2: Implement OCR Extraction in `ai.service` (AC: 3, 7)**
    - [ ] In `backend/app/modules/ai/service.py`, create a new function `perform_ocr_extraction(file_path: str) -> str`.
    - [ ] Integrate a Python OCR library (e.g., `pytesseract`, `easyocr`). Note: A PoC should be done first to select the best library for Vietnamese and English CVs.
    - [ ] The function should take a file path, perform OCR, and return the extracted text.
    - [ ] The main `process_cv_in_background` task should be updated to handle the new OCR pathway.
- [ ] **Task 3: Enhance Text Extraction Logic (AC: 1, 4)**
    - [ ] Review and update the `robust_section_split` function (likely in `ai/service.py`) with a more comprehensive dictionary of Vietnamese section headers (e.g., "Học vấn", "Kinh nghiệm làm việc", "Kỹ năng").
- [ ] **Task 4: Implement Testing (AC: 9, 10)**
    - [ ] In `backend/tests/modules/cv/test_cv_service.py`, add unit tests for the new routing logic, mocking the OCR and text extraction services.
    - [ ] In `backend/tests/modules/ai/test_ai_service.py`, add unit tests for the `perform_ocr_extraction` function, using sample images.
    - [ ] Ensure all existing tests pass to confirm no regressions.

## Dev Notes

### Previous Story Insights
- From Story 1.2, we know that a text extraction mechanism using `PyMuPDF` and `python-docx` already exists within the AI service. This story enhances that existing system. [Source: `docs/stories/1.2.story.md`]

### Data Models
- No direct changes to the database models are required for this story. The logic operates on the file before analysis data is saved. [Source: `docs/architecture/data-models.md`]

### API Specifications
- This story modifies the internal behavior of the `POST /cvs` endpoint. The external API contract remains unchanged. The user will still upload a file in the same way. [Source: `docs/architecture/api-specification.md#/cvs`]

### File Locations
- **CV Service Logic:** `backend/app/modules/cv/service.py` will be modified to include the routing logic. [Source: `docs/architecture/source-tree.md`]
- **AI Service Logic:** `backend/app/modules/ai/service.py` will be modified to include the new OCR extraction function. [Source: `docs/architecture/source-tree.md`]
- **Backend Tests:** New tests will be added in `backend/tests/modules/cv/` and `backend/tests/modules/ai/`. [Source: `docs/architecture/testing-strategy.md#Backend-Tests`]

### Technical Constraints
- All file processing must be handled in a FastAPI `BackgroundTask` to prevent blocking the HTTP response. [Source: `docs/architecture/backend-architecture.md#Data-Access-Layer`]
- Business logic must remain in the `service.py` files, not in `router.py`. [Source: `docs/architecture/backend-architecture.md#Data-Access-Layer`]
- All new Python code must follow `snake_case` for functions and variables. [Source: `docs/architecture/coding-standards.md#Naming-Conventions`]
- A Proof-of-Concept is required to select an OCR library that performs well with both English and Vietnamese text and meets the project's performance NFRs (<45s total processing).

## Testing
- **Test File Location**: Backend tests will be located in `backend/tests/modules/`, mirroring the application structure. For example, `backend/tests/modules/ai/test_ai_service.py`. [Source: `docs/architecture/testing-strategy.md#Backend-Tests`]
- **Test Standards**:
    - Tests will be written using `pytest`.
    - Asynchronous API tests should use `httpx`.
    - Dependencies such as database connections or external services (like the actual OCR engine call) should be mocked.
- **Testing Frameworks**: `pytest` and `httpx`. [Source: `docs/architecture/tech-stack.md`]
- **Specific Requirements**:
    - Test the routing logic in `cv.service` to ensure it correctly identifies and routes image-based vs. text-based CVs.
    - Test the `perform_ocr_extraction` function with sample CV images to validate text output quality.
    - All tests should utilize a variety of sample CV files (both text-based and image-based) from the `backend/data/cv_uploads/` directory.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-12 | 1.0 | Initial draft of Story 2.1 - Implement Advanced Preprocessing and OCR Layer | Bob (Scrum Master) |

## Dev Agent Record
*This section is to be populated by the Dev Agent during implementation.*

## QA Results
*This section is to be populated by the QA Agent during review.*
