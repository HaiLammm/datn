# Story 6.2: CV Deletion Feature (Completion)

## Status
Ready for Review

## Story
**As a** Job Seeker,
**I want** to delete my CVs from the CV detail/analysis page,
**So that** I can control my personal data from any view in the application.

## Acceptance Criteria

1. Delete button available on CV analysis page (`/cvs/[cv_id]/analysis`)
2. Delete button uses the existing `DeleteCVDialog` component with confirmation
3. After successful deletion from detail page, user is redirected to CV history list (`/cvs`)
4. Show success toast notification after deletion
5. Handle deletion errors gracefully with appropriate error messages

**Note:** Most of Story 6.2 (as defined in Epic 6) was already implemented in Story 6.1. This story completes the remaining requirements:
- AC 1 from Epic: Delete button on detail page (this story)
- AC 7 from Epic: Redirect to history list after delete from detail page (this story)

## Tasks / Subtasks

- [x] **Task 1: Create DeleteCVButton component for detail page (AC: 1, 2)**
  - [x] Create `frontend/features/cv/components/DeleteCVButton.tsx`
  - [x] Wrap `DeleteCVDialog` with redirect logic after successful deletion
  - [x] Accept `cvId`, `filename`, and optional `redirectTo` props
  - [x] Use `useRouter` from `next/navigation` for programmatic redirect
  - [x] Add `onDeleteSuccess` callback prop to `DeleteCVDialog` or handle internally

- [x] **Task 2: Update DeleteCVDialog to support redirect callback (AC: 3)**
  - [x] Modify `frontend/features/cv/components/DeleteCVDialog.tsx`
  - [x] Add optional `onDeleteSuccess?: () => void` prop
  - [x] Call `onDeleteSuccess` after successful deletion (before or after toast)
  - [x] Maintain backward compatibility (existing usage without callback still works)

- [x] **Task 3: Add Delete button to CV Analysis page (AC: 1, 3, 4)**
  - [x] Modify `frontend/app/cvs/[cv_id]/analysis/page.tsx`
  - [x] Fetch CV filename for display in delete dialog
  - [x] Add `DeleteCVButton` component to page header (next to "Back to My CVs" link)
  - [x] Configure redirect to `/cvs` after successful deletion
  - [x] Wrap with `DeleteModeProvider` if needed for context

- [x] **Task 4: Add CV filename to analysis response (AC: 1)**
  - [x] Modify `backend/app/modules/ai/schemas.py` - Add `cv_filename: str` to `AnalysisResult`
  - [x] Modify `backend/app/modules/ai/router.py` - Include `cv.filename` in response
  - [x] Update `packages/shared-types/src/cv-analysis.ts` - Add `cv_filename?: string` to `CVAnalysis`
  - [x] Alternative: Use hardcoded filename pattern from cv_id if minimal backend changes preferred

- [x] **Task 5: Unit Tests for DeleteCVButton (AC: 1, 2, 3)**
  - [x] Create `frontend/features/cv/components/DeleteCVButton.test.tsx`
  - [x] Test: Renders delete button
  - [x] Test: Opens confirmation dialog on click
  - [x] Test: Calls router.push after successful deletion
  - [x] Test: Shows error toast on deletion failure

- [x] **Task 6: E2E Test for delete from detail page (AC: 1, 3, 4, 5)**
  - [x] Update `frontend/e2e/cv-analysis.spec.ts`
  - [x] Test: Delete button visible on analysis page
  - [x] Test: Delete confirmation dialog appears
  - [x] Test: Successful deletion redirects to `/cvs`
  - [x] Test: CV no longer appears in list after deletion

## Dev Notes

### Previous Story Insights (Story 6.1)

Story 6.1 implemented the core CV deletion functionality:
- `DeleteCVDialog` component with confirmation dialog
- `deleteCVAction` server action in `frontend/features/cv/actions.ts`
- Backend `delete_cv` service in `backend/app/modules/cv/service.py`
- Delete button on CV history list cards

This story extends that functionality to the detail/analysis page.

[Source: docs/stories/6.1.story.md]

### Existing Components to Reuse

**DeleteCVDialog** (`frontend/features/cv/components/DeleteCVDialog.tsx`):
```typescript
interface DeleteCVDialogProps {
  cvId: string;
  filename: string;
}
```
- Uses `AlertDialog` from shadcn/ui
- Calls `deleteCVAction` server action
- Shows toast on success/failure
- Has "Don't ask again" checkbox for session

**DeleteModeProvider** (`frontend/features/cv/context/DeleteModeContext.tsx`):
- Provides `skipConfirmation` state for "Don't ask again" feature
- Must wrap components that use `DeleteCVDialog`

[Source: frontend/features/cv/components/DeleteCVDialog.tsx, frontend/features/cv/context/DeleteModeContext.tsx]

### File Locations

**Files to Create:**
- `frontend/features/cv/components/DeleteCVButton.tsx` - New component with redirect logic

**Files to Modify:**
- `frontend/features/cv/components/DeleteCVDialog.tsx` - Add `onDeleteSuccess` callback
- `frontend/app/cvs/[cv_id]/analysis/page.tsx` - Add delete button to header

[Source: docs/architecture/source-tree.md]

### API Endpoints

| Method | Endpoint | Description | Already Implemented |
|--------|----------|-------------|---------------------|
| DELETE | `/api/v1/cvs/{cv_id}` | Delete CV and associated data | Yes |
| GET | `/api/v1/cvs/{cv_id}/analysis` | Get CV analysis (has cv_id reference) | Yes |

No new backend endpoints required.

[Source: backend/app/modules/cv/router.py]

### Component Specifications

**New DeleteCVButton Component:**
```typescript
// frontend/features/cv/components/DeleteCVButton.tsx
interface DeleteCVButtonProps {
  cvId: string;
  filename: string;
  redirectTo?: string; // default: '/cvs'
}
```

**Updated DeleteCVDialog Props:**
```typescript
interface DeleteCVDialogProps {
  cvId: string;
  filename: string;
  onDeleteSuccess?: () => void; // NEW - optional callback
}
```

### Technical Constraints

- **Next.js Navigation:** Use `useRouter` from `next/navigation` for client-side redirect
- **Context Requirement:** `DeleteCVDialog` requires `DeleteModeProvider` context
- **Server Component Limitation:** Analysis page is a Server Component; delete button must be a Client Component

[Source: docs/architecture/frontend-architecture.md]

### Design Patterns

**Redirect after delete:**
```typescript
'use client';
import { useRouter } from 'next/navigation';

function DeleteCVButton({ cvId, filename, redirectTo = '/cvs' }: DeleteCVButtonProps) {
  const router = useRouter();
  
  const handleDeleteSuccess = () => {
    router.push(redirectTo);
  };
  
  return (
    <DeleteModeProvider>
      <DeleteCVDialog 
        cvId={cvId} 
        filename={filename}
        onDeleteSuccess={handleDeleteSuccess}
      />
    </DeleteModeProvider>
  );
}
```

### Getting CV Filename

The analysis page needs the CV filename for the delete dialog. 

**Recommended Solution:** Add `cv_filename` to the analysis response.

**Backend Change Required:**
```python
# backend/app/modules/ai/router.py - get_cv_analysis endpoint
# After line 45 (analysis = result.scalar_one_or_none())
# The 'cv' object is already loaded (line 28-34), use cv.filename

# Modify return to include cv_filename:
return schemas.AnalysisResult(
    **analysis.__dict__,
    cv_filename=cv.filename  # Add this field
)
```

**Schema Change:**
```python
# backend/app/modules/ai/schemas.py
class AnalysisResult(BaseModel):
    # ... existing fields ...
    cv_filename: str | None = None  # NEW field
```

**TypeScript Type Update:**
```typescript
// packages/shared-types/src/cv-analysis.ts
export interface CVAnalysis {
  // ... existing fields ...
  cv_filename?: string;  // NEW - optional for backward compatibility
}
```

[Source: backend/app/modules/ai/router.py:28-59, packages/shared-types/src/cv-analysis.ts]

## Testing

### Test Framework and Location
- **Framework:** Jest + React Testing Library (unit tests)
- **E2E:** Playwright
- **Location:** Co-located in `frontend/features/cv/components/`
- **Run Unit:** `npm test -- DeleteCVButton`
- **Run E2E:** `npx playwright test cv-analysis.spec.ts`

[Source: docs/architecture/testing-strategy.md]

### Test Scenarios Required

**Unit Tests (DeleteCVButton.test.tsx):**
1. Renders delete button with correct text
2. Opens confirmation dialog when clicked
3. Calls `router.push('/cvs')` after successful deletion
4. Does not redirect on deletion failure
5. Passes cvId and filename to DeleteCVDialog

**E2E Tests (cv-analysis.spec.ts):**
1. Delete button visible on CV analysis page
2. Clicking delete shows confirmation dialog
3. Confirming delete redirects to CV history
4. Deleted CV not visible in history list
5. Cancel button closes dialog without deleting

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-19 | 1.0 | Initial draft - CV Deletion completion story | Lem_SM (Scrum Master) |
| 2025-12-19 | 1.1 | PO Validation passed, status updated to Approved | Lem_SM (Scrum Master) |
| 2025-12-19 | 1.2 | Implementation complete, all tasks done | Lem_Dev (Developer) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via OpenCode)

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes List
1. **DeleteCVButton component created**: New reusable component that wraps `DeleteCVDialog` with redirect functionality. Includes `DeleteModeProvider` internally for context.
2. **DeleteCVDialog enhanced**: Added optional `onDeleteSuccess` callback prop with full backward compatibility.
3. **Backend API updated**: Added `cv_filename` field to `AnalysisResult` schema and router response for proper filename display in delete dialog.
4. **Analysis page updated**: Delete button added to page header with proper layout (flexbox between "Back to My CVs" link and delete button).
5. **Unit tests**: 8 tests covering rendering, dialog interaction, redirect logic, and error handling. All tests pass.
6. **E2E tests**: 5 new test cases added for delete functionality from analysis page (visibility, dialog, redirect, and list verification).
7. **Pre-existing issues**: One unrelated test failure in `CandidateCard.test.tsx` (not related to this story). ESLint errors in `/cvs/[cv_id]/page.tsx` are pre-existing.

### File List
**Created:**
- `frontend/features/cv/components/DeleteCVButton.tsx` - New component with redirect logic
- `frontend/features/cv/components/DeleteCVButton.test.tsx` - Unit tests (8 tests)

**Modified:**
- `frontend/features/cv/components/DeleteCVDialog.tsx` - Added `onDeleteSuccess` callback prop
- `frontend/app/cvs/[cv_id]/analysis/page.tsx` - Added DeleteCVButton to page header
- `backend/app/modules/ai/schemas.py` - Added `cv_filename` field to AnalysisResult
- `backend/app/modules/ai/router.py` - Include cv.filename in response
- `packages/shared-types/src/cv-analysis.ts` - Added `cv_filename` to CVAnalysis interface
- `frontend/e2e/cv-analysis.spec.ts` - Added 5 E2E tests for deletion from analysis page

---

## QA Results

### Review Date: 2025-12-19

### Reviewed By: Lem_QA (Test Architect)

### Risk Assessment

**Risk Profile:** LOW
- No auth/payment/security files touched (delete uses existing secured endpoints)
- Tests added to story: 8 unit tests + 5 E2E tests
- Diff size: ~300 lines (moderate, focused change)
- Story has 5 acceptance criteria (manageable scope)
- First review for this story

**Conclusion:** Standard review depth applied.

### Code Quality Assessment

**Overall: EXCELLENT**

The implementation demonstrates high-quality software engineering practices:

1. **Component Architecture:**
   - `DeleteCVButton` properly encapsulates `DeleteCVDialog` with redirect logic
   - Clean separation of concerns: Button handles navigation, Dialog handles deletion
   - `DeleteModeProvider` context correctly scoped within the button component

2. **Backend Changes:**
   - `cv_filename` field added cleanly to `AnalysisResult` schema with proper optional typing
   - Router correctly extracts filename from already-loaded CV object (no additional DB query)
   - Backward compatible - field is optional

3. **Type Safety:**
   - TypeScript types properly updated in `packages/shared-types/src/cv-analysis.ts`
   - Backend Pydantic schema matches frontend types

4. **Error Handling:**
   - Proper error propagation from `deleteCVAction`
   - Toast notifications for both success and failure states
   - Graceful fallback for missing `cv_filename`

### Requirements Traceability

| AC | Description | Unit Test | E2E Test | Status |
|---|---|---|---|---|
| AC1 | Delete button on analysis page | renders delete button | delete button visible | ✓ |
| AC2 | Uses DeleteCVDialog with confirmation | opens confirmation dialog | opens confirmation dialog | ✓ |
| AC3 | Redirect to /cvs after deletion | calls router.push('/cvs') | successful deletion redirects | ✓ |
| AC4 | Success toast notification | (via DeleteCVDialog mock) | (toast verification optional) | ✓ |
| AC5 | Error handling with messages | shows error toast on failure | cancel closes dialog | ✓ |

**Given-When-Then Coverage:**

- **AC1:** GIVEN user is on CV analysis page, WHEN page loads, THEN delete button is visible in header
- **AC2:** GIVEN delete button is visible, WHEN user clicks delete, THEN confirmation dialog appears with CV filename
- **AC3:** GIVEN confirmation dialog is open, WHEN user confirms deletion, THEN user is redirected to /cvs
- **AC4:** GIVEN deletion succeeds, WHEN redirect completes, THEN success toast is displayed
- **AC5:** GIVEN deletion fails, WHEN API returns error, THEN error toast is shown and no redirect occurs

### Refactoring Performed

None required. Implementation follows established patterns and coding standards.

### Compliance Check

- Coding Standards: ✓ ESLint passes, proper TypeScript usage, consistent naming
- Project Structure: ✓ Files placed in correct locations per source-tree.md
- Testing Strategy: ✓ Unit + E2E tests at appropriate levels
- All ACs Met: ✓ All 5 acceptance criteria fully implemented

### Improvements Checklist

- [x] All tests passing (8/8 unit tests, 5 E2E tests defined)
- [x] ESLint clean on all modified files
- [x] TypeScript compilation successful
- [x] Backend Python syntax valid
- [x] Backward compatibility maintained (cv_filename is optional)

### Security Review

**Status: PASS**

- Delete operation uses existing authenticated endpoint (`DELETE /api/v1/cvs/{cv_id}`)
- CV ownership verification occurs in backend before deletion
- `deleteCVAction` server action properly forwards authentication token
- No new security vulnerabilities introduced

### Performance Considerations

**Status: PASS**

- No additional database queries: `cv_filename` extracted from already-loaded CV object
- Redirect uses client-side `router.push()` - no server round-trip
- Component renders efficiently with React transitions

### Testability Evaluation

- **Controllability:** ✓ Props control all inputs, mocks work correctly
- **Observability:** ✓ Toast calls, router calls, dialog state all observable
- **Debuggability:** ✓ Clear component hierarchy, easy to trace issues

### Technical Debt

None identified. Clean implementation building on established patterns from Story 6.1.

### Gate Status

**Gate: PASS** → docs/qa/gates/6.2-cv-deletion-feature.yml

### Recommended Status

✓ **Ready for Done**

All acceptance criteria met, comprehensive test coverage, code quality excellent. No changes required.
