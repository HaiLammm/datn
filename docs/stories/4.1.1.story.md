# Story 4.1.1: Apply Role Guards to Existing Endpoints

## Status
Completed (Merged into Story 4.1)

> **Note:** This story was created as a follow-up to Story 4.1, but all its tasks were already completed as part of Story 4.1 implementation. The role guards have been applied to all existing endpoints:
> - CV routes use `require_job_seeker`
> - Jobs routes use `require_recruiter`
> - Frontend layouts have role-based guards
> - Tests have been updated accordingly

## Story
**As a** developer,
**I want** to apply role-based guards to all existing API endpoints and frontend routes,
**So that** job_seekers can only access CV features and recruiters can only access Job features, ensuring proper authorization across the entire application.

## Dependencies
- **Requires:** Story 4.1 (Role-Based Authorization System) to be **Done**
- Story 4.1 creates the role guards (`require_job_seeker`, `require_recruiter`, `require_admin`)
- This story applies those guards to existing code

## Acceptance Criteria

### Backend - CV Module (Epic 1 & 2)
1. All `/api/v1/cvs/*` endpoints use `require_job_seeker` guard
2. Job seekers and admins can access CV endpoints
3. Recruiters receive 403 when accessing CV endpoints
4. Existing CV ownership checks remain intact

### Backend - Jobs Module (Epic 3)
5. All `/api/v1/jobs/*` endpoints use `require_recruiter` guard
6. Recruiters and admins can access Jobs endpoints
7. Job seekers receive 403 when accessing Jobs endpoints
8. Existing JD ownership checks remain intact

### Backend - Skill Matching (Epic 5)
9. `/api/v1/cvs/{id}/match` endpoint - accessible by CV owner (job_seeker) only
10. Determine appropriate role for other skill-related endpoints

### Frontend - CVs Routes
11. `/cvs/*` layout redirects recruiters to `/jobs`
12. CVs navigation only visible to job_seekers and admins

### Frontend - Jobs Routes
13. `/jobs/*` layout redirects job_seekers to `/cvs`
14. Jobs navigation only visible to recruiters and admins

### Testing
15. Update existing backend tests to use correct role for each endpoint
16. Add tests for "wrong role" scenarios (403 responses)
17. Update E2E tests to use appropriate user roles

## Tasks / Subtasks

- [ ] **Task 1: Update CV Router - Backend (AC: 1, 2, 3, 4)**
  - [ ] Open `backend/app/modules/cvs/router.py`
  - [ ] Import `require_job_seeker` from `app.modules.auth.dependencies`
  - [ ] Replace all `Depends(get_current_user)` with `Depends(require_job_seeker)`:
    - [ ] `POST /cvs/` - upload CV
    - [ ] `GET /cvs/` - list user's CVs
    - [ ] `GET /cvs/{cv_id}` - get CV details
    - [ ] `DELETE /cvs/{cv_id}` - delete CV
    - [ ] `PATCH /cvs/{cv_id}/visibility` - update visibility
    - [ ] `GET /cvs/{cv_id}/analysis` - get CV analysis
  - [ ] Verify ownership checks still work (user can only access own CVs)

- [ ] **Task 2: Update Jobs Router - Backend (AC: 5, 6, 7, 8)**
  - [ ] Open `backend/app/modules/jobs/router.py`
  - [ ] Import `require_recruiter` from `app.modules.auth.dependencies`
  - [ ] Replace all `Depends(get_current_user)` with `Depends(require_recruiter)`:
    - [ ] `POST /jobs/jd` - create JD
    - [ ] `GET /jobs/jd` - list user's JDs
    - [ ] `GET /jobs/jd/{jd_id}` - get JD details
    - [ ] `DELETE /jobs/jd/{jd_id}` - delete JD
    - [ ] `PATCH /jobs/jd/{jd_id}/parsed-requirements` - update parsed requirements
    - [ ] `GET /jobs/jd/{jd_id}/candidates` - get ranked candidates
    - [ ] `GET /jobs/jd/{jd_id}/candidates/{cv_id}` - get candidate CV (recruiter view)
    - [ ] `GET /jobs/jd/{jd_id}/candidates/{cv_id}/file` - download candidate CV file
    - [ ] `POST /jobs/search` - semantic search
  - [ ] Verify ownership checks still work (user can only access own JDs)

- [ ] **Task 3: Review Skill Matching Endpoints (AC: 9, 10)**
  - [ ] Open `backend/app/modules/cvs/router.py` (or wherever match endpoint is)
  - [ ] `POST /cvs/{cv_id}/match` - verify this uses `require_job_seeker`
    - [ ] Only CV owner should be able to match their CV against a JD
  - [ ] Review any other skill-related endpoints in Epic 5

- [ ] **Task 4: Update CVs Frontend Layout (AC: 11)**
  - [ ] Open `frontend/app/cvs/layout.tsx`
  - [ ] Import `getSession` from `@/lib/auth`
  - [ ] Add role check after authentication:
    ```typescript
    const session = await getSession();
    if (!session) redirect('/login');
    if (session.user.role === 'recruiter') redirect('/jobs');
    ```
  - [ ] Verify redirect works correctly

- [ ] **Task 5: Update Jobs Frontend Layout (AC: 13)**
  - [ ] Open `frontend/app/jobs/layout.tsx`
  - [ ] Import `getSession` from `@/lib/auth`
  - [ ] Add role check after authentication:
    ```typescript
    const session = await getSession();
    if (!session) redirect('/login');
    if (session.user.role === 'job_seeker') redirect('/cvs');
    ```
  - [ ] Verify redirect works correctly

- [ ] **Task 6: Update Navigation Component (AC: 12, 14)**
  - [ ] Open `frontend/components/common/Navigation.tsx` (or Header component)
  - [ ] Fetch user role from session/context
  - [ ] Conditionally render menu items:
    ```typescript
    {(role === 'job_seeker' || role === 'admin') && (
      <Link href="/cvs">My CVs</Link>
    )}
    {(role === 'recruiter' || role === 'admin') && (
      <Link href="/jobs">Job Descriptions</Link>
    )}
    ```
  - [ ] Test navigation visibility per role

- [ ] **Task 7: Update Backend Tests - CV Module (AC: 15, 16)**
  - [ ] Open `backend/tests/modules/cv/` test files
  - [ ] Update fixtures to create `job_seeker` role users for CV tests
  - [ ] Add test cases for recruiter accessing CV endpoints (expect 403):
    - [ ] `test_upload_cv_as_recruiter_forbidden`
    - [ ] `test_get_cvs_as_recruiter_forbidden`
    - [ ] `test_delete_cv_as_recruiter_forbidden`
  - [ ] Verify existing tests still pass with job_seeker role

- [ ] **Task 8: Update Backend Tests - Jobs Module (AC: 15, 16)**
  - [ ] Open `backend/tests/modules/jobs/` test files
  - [ ] Update fixtures to create `recruiter` role users for Jobs tests
  - [ ] Add test cases for job_seeker accessing Jobs endpoints (expect 403):
    - [ ] `test_create_jd_as_job_seeker_forbidden`
    - [ ] `test_get_jds_as_job_seeker_forbidden`
    - [ ] `test_get_candidates_as_job_seeker_forbidden`
    - [ ] `test_search_candidates_as_job_seeker_forbidden`
  - [ ] Verify existing tests still pass with recruiter role

- [ ] **Task 9: Update E2E Tests (AC: 17)**
  - [ ] Update `frontend/e2e/cv-analysis.spec.ts`:
    - [ ] Use job_seeker user for CV tests
    - [ ] Add test: recruiter cannot access /cvs (redirected)
  - [ ] Create/Update `frontend/e2e/jobs.spec.ts`:
    - [ ] Use recruiter user for Jobs tests
    - [ ] Add test: job_seeker cannot access /jobs (redirected)
  - [ ] Update test fixtures/helpers to support role-based users

- [ ] **Task 10: Update Conftest/Fixtures (AC: 15)**
  - [ ] Open `backend/tests/conftest.py`
  - [ ] Update `create_test_user` fixture to accept role parameter:
    ```python
    @pytest.fixture
    async def create_job_seeker_user(db):
        return await create_user(db, role='job_seeker')
    
    @pytest.fixture
    async def create_recruiter_user(db):
        return await create_user(db, role='recruiter')
    
    @pytest.fixture
    async def create_admin_user(db):
        return await create_user(db, role='admin')
    ```
  - [ ] Update existing fixtures that need specific roles

- [ ] **Task 11: Manual Testing**
  - [ ] Login as job_seeker:
    - [ ] Can access /cvs/* - PASS
    - [ ] Cannot access /jobs/* (redirected) - PASS
    - [ ] Navigation shows only CV menu items - PASS
  - [ ] Login as recruiter:
    - [ ] Can access /jobs/* - PASS
    - [ ] Cannot access /cvs/* (redirected) - PASS
    - [ ] Navigation shows only Jobs menu items - PASS
  - [ ] Login as admin:
    - [ ] Can access all routes - PASS
    - [ ] Navigation shows all menu items - PASS
  - [ ] API tests with wrong role return 403

- [ ] **Task 12: Update API Documentation (Optional)**
  - [ ] Add role requirements to API endpoint documentation
  - [ ] Update OpenAPI/Swagger descriptions if applicable

## Dev Notes

### Files to Modify

**Backend - CV Module:**
```
backend/app/modules/cvs/
├── router.py              # Change get_current_user → require_job_seeker
└── (no changes to service.py, models.py, schemas.py)

backend/tests/modules/cv/
├── test_cv_router.py      # Update to use job_seeker role
├── test_cv_upload.py      # Update to use job_seeker role
├── test_visibility.py     # Update to use job_seeker role
└── (add forbidden tests)
```

**Backend - Jobs Module:**
```
backend/app/modules/jobs/
├── router.py              # Change get_current_user → require_recruiter
└── (no changes to service.py, models.py, schemas.py)

backend/tests/modules/jobs/
├── test_jd_router.py      # Update to use recruiter role
├── test_candidates.py     # Update to use recruiter role
├── test_search.py         # Update to use recruiter role
└── (add forbidden tests)
```

**Frontend:**
```
frontend/app/
├── cvs/
│   └── layout.tsx         # Add role check
├── jobs/
│   └── layout.tsx         # Add role check
└── (dashboard already handled in 4.1)

frontend/components/common/
└── Navigation.tsx         # Add role-based menu rendering (or Header.tsx)
```

### Code Changes - Backend

**Before (current code):**
```python
# backend/app/modules/cvs/router.py
from app.modules.auth.dependencies import get_current_user

@router.post("/", response_model=schemas.CVResponse)
async def upload_cv(
    current_user: User = Depends(get_current_user),  # Any authenticated user
    # ...
):
```

**After (with role guard):**
```python
# backend/app/modules/cvs/router.py
from app.modules.auth.dependencies import require_job_seeker

@router.post("/", response_model=schemas.CVResponse)
async def upload_cv(
    current_user: User = Depends(require_job_seeker),  # Only job_seeker and admin
    # ...
):
```

### Code Changes - Frontend Layout

**CVs Layout Guard:**
```typescript
// frontend/app/cvs/layout.tsx
import { redirect } from 'next/navigation';
import { getSession } from '@/lib/auth';

export default async function CVsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await getSession();
  
  if (!session) {
    redirect('/login');
  }
  
  // Role check: only job_seeker and admin can access
  if (session.user.role === 'recruiter') {
    redirect('/jobs');
  }
  
  return <>{children}</>;
}
```

**Jobs Layout Guard:**
```typescript
// frontend/app/jobs/layout.tsx
import { redirect } from 'next/navigation';
import { getSession } from '@/lib/auth';

export default async function JobsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await getSession();
  
  if (!session) {
    redirect('/login');
  }
  
  // Role check: only recruiter and admin can access
  if (session.user.role === 'job_seeker') {
    redirect('/cvs');
  }
  
  return <>{children}</>;
}
```

### Test Fixtures Update

```python
# backend/tests/conftest.py
import pytest
from app.modules.users.models import User

@pytest.fixture
async def job_seeker_user(db: AsyncSession) -> User:
    """Create a job_seeker user for testing."""
    user = User(
        email="jobseeker@test.com",
        hashed_password=get_password_hash("test123"),
        role="job_seeker",
        is_active=True
    )
    db.add(user)
    await db.commit()
    await db.refresh(user)
    return user

@pytest.fixture
async def recruiter_user(db: AsyncSession) -> User:
    """Create a recruiter user for testing."""
    user = User(
        email="recruiter@test.com",
        hashed_password=get_password_hash("test123"),
        role="recruiter",
        is_active=True
    )
    db.add(user)
    await db.commit()
    await db.refresh(user)
    return user

@pytest.fixture
async def job_seeker_client(async_client: AsyncClient, job_seeker_user: User):
    """Authenticated client with job_seeker role."""
    # Login and get cookies
    await async_client.post("/api/v1/auth/login", json={
        "email": job_seeker_user.email,
        "password": "test123"
    })
    return async_client

@pytest.fixture
async def recruiter_client(async_client: AsyncClient, recruiter_user: User):
    """Authenticated client with recruiter role."""
    await async_client.post("/api/v1/auth/login", json={
        "email": recruiter_user.email,
        "password": "test123"
    })
    return async_client
```

### Forbidden Test Examples

```python
# backend/tests/modules/cv/test_role_access.py
import pytest

@pytest.mark.asyncio
async def test_recruiter_cannot_upload_cv(recruiter_client):
    """Recruiter should get 403 when trying to upload CV."""
    response = await recruiter_client.post(
        "/api/v1/cvs/",
        files={"file": ("test.pdf", b"dummy content", "application/pdf")}
    )
    assert response.status_code == 403
    assert "job_seeker" in response.json()["detail"].lower()

@pytest.mark.asyncio
async def test_recruiter_cannot_list_cvs(recruiter_client):
    """Recruiter should get 403 when trying to list CVs."""
    response = await recruiter_client.get("/api/v1/cvs/")
    assert response.status_code == 403


# backend/tests/modules/jobs/test_role_access.py
@pytest.mark.asyncio
async def test_job_seeker_cannot_create_jd(job_seeker_client):
    """Job seeker should get 403 when trying to create JD."""
    response = await job_seeker_client.post(
        "/api/v1/jobs/jd",
        json={"title": "Test JD", "description": "Test"}
    )
    assert response.status_code == 403
    assert "recruiter" in response.json()["detail"].lower()

@pytest.mark.asyncio
async def test_job_seeker_cannot_search_candidates(job_seeker_client):
    """Job seeker should get 403 when trying to search candidates."""
    response = await job_seeker_client.post(
        "/api/v1/jobs/search",
        json={"query": "python developer"}
    )
    assert response.status_code == 403
```

### Affected Stories Reference

| Story | Module | Current Guard | New Guard |
|-------|--------|---------------|-----------|
| 1.1 | CVs - Upload | `get_current_user` | `require_job_seeker` |
| 1.2 | CVs - Analysis | `get_current_user` | `require_job_seeker` |
| 2.2 | CVs - Delete | `get_current_user` | `require_job_seeker` |
| 3.1 | Jobs - CRUD | `get_current_user` | `require_recruiter` |
| 3.2 | Jobs - Parsing | `get_current_user` | `require_recruiter` |
| 3.3 | Jobs - Ranking | `get_current_user` | `require_recruiter` |
| 3.4 | Jobs - Search | `get_current_user` | `require_recruiter` |
| 3.5 | Jobs - Frontend | Auth only | Auth + role check |
| 3.6 | Jobs - Candidates UI | Auth only | Auth + role check |
| 3.7 | Jobs - Search UI | Auth only | Auth + role check |
| 3.8 | Jobs - CV Access | `get_current_user` | `require_recruiter` |
| 5.5 | CVs - Match | `get_current_user` | `require_job_seeker` |

### Error Message Consistency

Ensure consistent error messages across all guards:

| Scenario | HTTP Status | Message |
|----------|-------------|---------|
| Recruiter accessing CVs | 403 | "Access denied. This feature is for Job Seekers only." |
| Job Seeker accessing Jobs | 403 | "Access denied. This feature is for Recruiters only." |
| Non-admin accessing Admin | 403 | "Admin privileges required" |

## Testing

### Backend Tests
- **Location:** `backend/tests/modules/cv/`, `backend/tests/modules/jobs/`
- **Framework:** pytest + pytest-asyncio + httpx
- **New Test Files:**
  - `backend/tests/modules/cv/test_role_access.py`
  - `backend/tests/modules/jobs/test_role_access.py`

### Frontend Tests
- **Location:** `frontend/app/cvs/__tests__/`, `frontend/app/jobs/__tests__/`
- **Framework:** Jest + React Testing Library
- **Test Cases:**
  - Layout redirect logic

### E2E Tests
- **Location:** `frontend/e2e/`
- **Framework:** Playwright
- **Test Cases:**
  - Job seeker flow with correct access
  - Recruiter flow with correct access
  - Cross-role access blocked

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story draft - Apply Role Guards to Existing Endpoints | Bob (SM) |

## Dev Agent Record

### Agent Model Used
_To be filled during implementation_

### Debug Log References
_To be filled during implementation_

### Completion Notes List
_To be filled during implementation_

### File List
_To be filled during implementation_

## QA Results
_To be filled after QA review_
