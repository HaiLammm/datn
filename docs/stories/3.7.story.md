# Story 3.7: Semantic Search Frontend

## Status
Done

## Story
**As a** Talent Seeker (Recruiter),
**I want** a search interface for finding candidates using natural language,
**So that** I can quickly discover relevant profiles without uploading a full Job Description.

## Acceptance Criteria

1. Tao search page voi search bar tai `/jobs/search`
2. Search bar ho tro nhap query bang ngon ngu tu nhien (e.g., "Python developer with 3 years AWS experience")
3. Display search results voi relevance scores (0-100)
4. Show brief candidate preview (filename, summary snippet, matched skills)
5. Link to full CV profile tai `/jobs/candidates/{cvId}` (route moi cho recruiter xem CV khong can JD context)
6. Support pagination (limit, offset) giong nhu Story 3.6
7. Support minimum score filtering (min_score slider)
8. Show parsed query interpretation (extracted skills, experience) cho user review
9. Empty state khi khong co ket qua phu hop
10. Loading state voi skeleton cards khi dang search
11. Error handling khi API fail voi retry button
12. Responsive design (mobile/tablet/desktop)
13. Accessibility support (ARIA labels, keyboard navigation)
14. Unit tests cho components
15. Search history (optional/nice-to-have) - store recent searches in localStorage

## Tasks / Subtasks

- [x] **Task 1: Add Shared Types for Search (AC: 3, 8)**
    - [x] Verify types exist in `packages/shared-types/src/job.ts`:
        - [x] `SemanticSearchRequest` interface
        - [x] `ParsedQueryResponse` interface
        - [x] `SearchResultResponse` interface
        - [x] `SearchResultListResponse` interface
    - [x] If missing, add them from Story 3.4 backend schemas
    - [x] Export from `packages/shared-types/src/index.ts`
    - [x] Run `npm run build` in packages/shared-types

- [x] **Task 2: Update Job Service Layer (AC: 1, 6, 7)**
    - [x] Add method to `frontend/services/job.service.ts`:
        - [x] `searchCandidates(params: SemanticSearchParams): Promise<SearchResultListResponse>`
    - [x] `SemanticSearchParams` interface: `{ query: string; limit?: number; offset?: number; min_score?: number }`
    - [x] Follow existing patterns from `getCandidatesForJD`

- [x] **Task 3: Create Server Actions for Search (AC: 1, 6, 7)**
    - [x] Update `frontend/features/jobs/actions.ts`
    - [x] Implement `searchCandidatesAction(params: SemanticSearchParams): Promise<SearchResultListResponse | null>`
    - [x] Handle errors and return null on failure
    - [x] Add Zod validation for query (min 2 characters)

- [x] **Task 4: Create SearchBar Component (AC: 2, 13)**
    - [x] Create `frontend/features/jobs/components/SearchBar.tsx`
    - [x] Props: `onSearch: (query: string) => void`, `loading?: boolean`, `placeholder?: string`
    - [x] Input field with search icon
    - [x] Submit button (or Enter key submission)
    - [x] Clear button when query is not empty
    - [x] Debounce input (500ms) for auto-search (optional)
    - [x] Accessibility: `role="search"`, `aria-label`, keyboard support

- [x] **Task 5: Create ParsedQueryDisplay Component (AC: 8)**
    - [x] Create `frontend/features/jobs/components/ParsedQueryDisplay.tsx`
    - [x] Props: `parsedQuery: ParsedQueryResponse`
    - [x] Display:
        - [x] "Ky nang tim kiem:" with extracted skills as badges
        - [x] "Kinh nghiem:" if experience_keywords present
        - [x] Raw query text (collapsed by default)
    - [x] Collapsible section for details

- [x] **Task 6: Create SearchResultCard Component (AC: 3, 4, 5, 13)**
    - [x] Create `frontend/features/jobs/components/SearchResultCard.tsx`
    - [x] Props: `result: SearchResultResponse`, `rank: number`
    - [x] Display:
        - [x] Rank number (#1, #2, ...)
        - [x] Relevance score with MatchScoreBadge (reuse from Story 3.6)
        - [x] Filename or "CV #{cv_id.slice(0,8)}"
        - [x] CV summary snippet (truncated to 2 lines)
        - [x] Matched skills as green badges (reuse SkillBadges)
        - [x] "View CV" button (links to CV detail or opens modal)
    - [x] Card hover effect
    - [x] Responsive layout

- [x] **Task 7: Create SearchResultList Component (AC: 3, 6, 7, 9, 10, 11)**
    - [x] Create `frontend/features/jobs/components/SearchResultList.tsx`
    - [x] Props: `results: SearchResultResponse[]`, `total: number`, `loading: boolean`, `error: string | null`
    - [x] State: `page`, `pageSize`, `minScore`
    - [x] Display list of SearchResultCard components
    - [x] Pagination controls (reuse CandidatePagination from Story 3.6)
    - [x] Min score filter (reuse MinScoreFilter from Story 3.6)
    - [x] Empty state: "Khong tim thay ung vien phu hop. Thu tim kiem khac."
    - [x] Loading state: Skeleton cards (4-6 cards)
    - [x] Error state: Error message with retry button

- [x] **Task 8: Create SemanticSearchPage Component (AC: 1, 2, 8, 12)**
    - [x] Create `frontend/features/jobs/components/SemanticSearchPage.tsx` (Client Component)
    - [x] Manage search state: `query`, `results`, `parsedQuery`, `loading`, `error`
    - [x] Integrate SearchBar, ParsedQueryDisplay, SearchResultList
    - [x] Handle search submission and API call
    - [x] Show ParsedQueryDisplay after search completes

- [x] **Task 9: Create Search Page Route (AC: 1, 12)**
    - [x] Create `frontend/app/jobs/search/page.tsx`
    - [x] Server Component with authentication guard
    - [x] Render SemanticSearchPage component
    - [x] Page title: "Tim kiem ung vien"
    - [x] Back button to jobs dashboard

- [x] **Task 10: Create Candidate CV Page Route (AC: 5)**
    - [x] Create `frontend/app/jobs/candidates/[cvId]/page.tsx`
    - [x] Server Component with authentication guard
    - [x] Reuse UI layout from `/jobs/jd/[jdId]/candidates/[cvId]/page.tsx`
    - [x] Differences from JD-context page:
        - [x] No JD context - remove "Do phu hop voi JD" section
        - [x] Back button links to `/jobs/search` instead of `/jobs/jd/{jdId}/candidates`
        - [x] Page title: "Thong tin ung vien" (not "Ung vien cho {JD title}")
    - [x] Display:
        - [x] CV filename and upload date
        - [x] CV Quality Score (ScoreGauge component)
        - [x] AI Summary
        - [x] Skill Breakdown (SkillBreakdownCard)
        - [x] Skill Categories or Extracted Skills
        - [x] PDF Preview (PDFPreviewSection - adapt for new route)
    - [x] Add new server action: `getCandidateCVFromSearchAction(cvId: string)`
    - [x] Add new backend endpoint if needed: `GET /api/v1/jobs/candidates/{cvId}`
    - [x] Handle CV visibility (private CV shows appropriate message)

- [ ] **Task 11 (Optional): Create Search History Feature (AC: 15)** *(Deferred - Nice-to-have)*
    - [ ] Create `frontend/features/jobs/hooks/useSearchHistory.ts`
    - [ ] Store recent searches in localStorage (max 10)
    - [ ] Functions: `addSearch`, `getSearches`, `clearSearches`
    - [ ] Create SearchHistory component showing recent searches
    - [ ] Click on history item to re-run search

- [x] **Task 12: Write Unit Tests (AC: 14)**
    - [x] Create `frontend/features/jobs/components/SearchBar.test.tsx`
        - [x] Test: Renders search input and button
        - [x] Test: Calls onSearch when submitted
        - [x] Test: Clear button works
        - [x] Test: Has correct ARIA attributes
    - [x] Create `frontend/features/jobs/components/ParsedQueryDisplay.test.tsx`
        - [x] Test: Shows extracted skills
        - [x] Test: Shows experience keywords
        - [x] Test: Handles empty parsed query
    - [x] Create `frontend/features/jobs/components/SearchResultCard.test.tsx`
        - [x] Test: Renders result info correctly
        - [x] Test: Shows correct rank
        - [x] Test: Links to CV page
        - [x] Test: Color-coded score badge
    - [x] Create `frontend/features/jobs/components/SearchResultList.test.tsx`
        - [x] Test: Renders list of results
        - [x] Test: Shows empty state
        - [x] Test: Shows loading state
        - [x] Test: Shows error with retry
    - [x] Use Jest + React Testing Library
    - [x] Mock server actions

- [x] **Task 13: Manual Testing (AC: 12, 13)**
    - [x] Test responsive design on mobile (375px), tablet (768px), desktop (1920px)
    - [x] Test keyboard navigation (Tab through elements, Enter to search)
    - [x] Test screen reader compatibility
    - [x] Test various query formats (English, Vietnamese, mixed)
    - [x] Test empty query handling
    - [x] Test pagination and filtering
    - [x] Cross-browser testing: Chrome, Firefox

## Dev Notes

### Previous Story Insights

**From Story 3.4 (Semantic Candidate Search Backend):**
- Backend endpoint ready: `POST /api/v1/jobs/search`
- Request body: `{ query: string, limit?: number, offset?: number, min_score?: number }`
- Returns `SearchResultListResponse` with paginated results and parsed query
- Query validation: min 2 characters, max reasonable length
- Scoring: 70% skill match + 30% keyword match
- Supports Vietnamese and English queries

**From Story 3.6 (Candidate Results Frontend):**
- Reusable components: `MatchScoreBadge`, `SkillBadges`, `CandidatePagination`, `MinScoreFilter`
- Pagination pattern: limit/offset with page size selector
- State management pattern with useCallback/useEffect
- Error handling with retry button

**[Source: docs/stories/3.4.story.md, docs/stories/3.6.story.md]**

### API Specifications

**Endpoint:** `POST /api/v1/jobs/search`

**Request Body:**
```typescript
interface SemanticSearchRequest {
  query: string;       // Natural language query (min 2 chars)
  limit?: number;      // Default 20, max 100
  offset?: number;     // Default 0
  min_score?: number;  // Default 0, range 0-100
}
```

**Response Schema:**
```typescript
interface SearchResultListResponse {
  items: SearchResultResponse[];
  total: number;
  limit: number;
  offset: number;
  parsed_query: ParsedQueryResponse;
}

interface SearchResultResponse {
  cv_id: string;           // UUID
  user_id: number;
  relevance_score: number; // 0-100
  matched_skills: string[];
  cv_summary: string | null;
  filename: string | null;
}

interface ParsedQueryResponse {
  extracted_skills: string[];
  experience_keywords: string[];
  raw_query: string;
}
```

**Error Responses:**
- `400`: Query too short (< 2 chars) or empty
- `401`: Not authenticated
- `422`: Validation error

**[Source: backend/app/modules/jobs/router.py, backend/app/modules/jobs/schemas.py]**

### File Locations

**Files to Create:**
```
frontend/
├── app/jobs/
│   ├── search/
│   │   └── page.tsx                    # Search page route
│   └── candidates/
│       └── [cvId]/
│           └── page.tsx                # Candidate CV page (no JD context)
├── features/jobs/components/
│   ├── SearchBar.tsx                   # Search input component
│   ├── SearchBar.test.tsx
│   ├── ParsedQueryDisplay.tsx          # Query interpretation display
│   ├── ParsedQueryDisplay.test.tsx
│   ├── SearchResultCard.tsx            # Single result card
│   ├── SearchResultCard.test.tsx
│   ├── SearchResultList.tsx            # Results list with pagination
│   ├── SearchResultList.test.tsx
│   └── SemanticSearchPage.tsx          # Main search page client component
└── features/jobs/hooks/
    └── useSearchHistory.ts             # Optional: Search history hook
```

**Files to Modify:**
```
frontend/
├── features/jobs/actions.ts            # Add searchCandidatesAction, getCandidateCVFromSearchAction
├── services/job.service.ts             # Add searchCandidates, getCandidateCVFromSearch methods
└── app/jobs/page.tsx                   # Add link to search page
├── app/jobs/jd/[jdId]/candidates/[cvId]/PDFPreviewSection.tsx  # May need to adapt for new route
packages/shared-types/src/
├── job.ts                              # Verify search types exist
└── index.ts                            # Export search types
```

**[Source: docs/architecture/source-tree.md, docs/architecture/frontend-architecture.md]**

### Component Reuse from Story 3.6

The following components from Story 3.6 should be reused:

1. **MatchScoreBadge** - Display relevance score with color coding
   - Location: `frontend/features/jobs/components/MatchScoreBadge.tsx`
   - Usage: `<MatchScoreBadge score={result.relevance_score} />`

2. **SkillBadges** - Display matched skills
   - Location: `frontend/features/jobs/components/SkillBadges.tsx`
   - Usage: `<SkillBadges skills={result.matched_skills} type="matched" />`

3. **CandidatePagination** - Pagination controls
   - Location: `frontend/features/jobs/components/CandidatePagination.tsx`
   - Usage: Integrate in SearchResultList

4. **MinScoreFilter** - Score filter slider
   - Location: `frontend/features/jobs/components/MinScoreFilter.tsx`
   - Usage: Integrate in SearchResultList

**[Source: frontend/features/jobs/components/]**

### Candidate CV Page (No JD Context)

Route `/jobs/candidates/[cvId]` cho phep Recruiter xem CV tu ket qua Semantic Search ma khong can JD context.

**Khac biet voi `/jobs/jd/[jdId]/candidates/[cvId]`:**

| Feature | JD Context Page | Search Context Page |
|---------|-----------------|---------------------|
| Route | `/jobs/jd/[jdId]/candidates/[cvId]` | `/jobs/candidates/[cvId]` |
| Back button | `/jobs/jd/{jdId}/candidates` | `/jobs/search` |
| "Do phu hop voi JD" section | Co (hien thi match_score, matched_skills) | Khong (khong co JD de so sanh) |
| Page title | "Ung vien cho {JD title}" | "Thong tin ung vien" |
| API endpoint | `GET /api/v1/jobs/jd/{jdId}/candidates/{cvId}` | `GET /api/v1/jobs/candidates/{cvId}` (moi) |

**Backend API Requirement:**

Can tao endpoint moi hoac reuse endpoint hien co:
```
GET /api/v1/jobs/candidates/{cv_id}
```

Response tuong tu `RecruiterCVAccessResponse` nhung khong co `match_score` va `matched_skills`:
```typescript
interface CandidateCVFromSearchResponse {
  cv_id: string;
  filename: string;
  uploaded_at: string;
  ai_score: number | null;
  ai_summary: string | null;
  extracted_skills: string[] | null;
  skill_breakdown: Record<string, number> | null;
  skill_categories: Record<string, string[]> | null;
  is_public: boolean;
}
```

**Component Reuse:**
- `ScoreGauge` - from `features/cv/components/`
- `SkillCloud` - from `features/cv/components/`
- `SkillCategoriesDisplay` - from `features/cv/components/`
- `SkillBreakdownCard` - from `features/cv/components/`
- `PDFPreviewSection` - adapt from `app/jobs/jd/[jdId]/candidates/[cvId]/`

**[Source: frontend/app/jobs/jd/[jdId]/candidates/[cvId]/page.tsx]**

### State Management Pattern

**SemanticSearchPage State:**
```typescript
const [query, setQuery] = useState('');
const [results, setResults] = useState<SearchResultResponse[]>([]);
const [total, setTotal] = useState(0);
const [parsedQuery, setParsedQuery] = useState<ParsedQueryResponse | null>(null);
const [loading, setLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
const [page, setPage] = useState(0);
const [pageSize, setPageSize] = useState(20);
const [minScore, setMinScore] = useState(0);

const handleSearch = useCallback(async (searchQuery: string) => {
  if (searchQuery.trim().length < 2) {
    setError('Query phai co it nhat 2 ky tu');
    return;
  }
  
  setLoading(true);
  setError(null);
  setQuery(searchQuery);
  
  try {
    const result = await searchCandidatesAction({
      query: searchQuery,
      limit: pageSize,
      offset: page * pageSize,
      min_score: minScore,
    });
    
    if (result) {
      setResults(result.items);
      setTotal(result.total);
      setParsedQuery(result.parsed_query);
    } else {
      setError('Tim kiem that bai. Vui long thu lai.');
    }
  } catch (err) {
    setError('Co loi xay ra. Vui long thu lai.');
  } finally {
    setLoading(false);
  }
}, [pageSize, page, minScore]);

// Re-search when pagination/filter changes
useEffect(() => {
  if (query) {
    handleSearch(query);
  }
}, [page, pageSize, minScore]); // Note: query excluded to avoid loop
```

**[Source: docs/architecture/frontend-architecture.md#State-Management-Architecture]**

### Technical Constraints

1. **Type Sharing:**
   - Import types from `@datn/shared-types`
   - Match backend schema exactly

2. **Authentication:**
   - Search page requires authentication
   - Use `cookies()` from `next/headers` in Server Component
   - Forward token via `getAccessToken()` helper

3. **Pagination:**
   - Default page size: 20
   - Max page size: 100 (enforced by backend)
   - Use offset-based pagination

4. **Performance:**
   - Debounce search input if implementing auto-search
   - Client-side pagination for subsequent pages
   - Show skeleton loading state

5. **Error Handling:**
   - Show user-friendly error messages in Vietnamese
   - Retry button for transient failures
   - Handle 400 (query too short) gracefully

**[Source: docs/architecture/coding-standards.md]**

### Accessibility Guidelines

1. **Search Form:**
   - Use `role="search"` on form element
   - `aria-label="Tim kiem ung vien"` on search input
   - Submit button must have clear label

2. **Results:**
   - Use `role="list"` and `role="listitem"` for results
   - Each card should be focusable and have descriptive label
   - Announce result count to screen readers

3. **Pagination:**
   - Buttons with `aria-label` ("Trang truoc", "Trang sau")
   - Current page announced

4. **Filter:**
   - Slider with `aria-valuemin`, `aria-valuemax`, `aria-valuenow`
   - Associated label

**[Source: docs/stories/3.5.story.md#Accessibility-Guidelines, docs/stories/3.6.story.md]**

### Dependencies

- **Story 3.7 depends on:**
  - Story 3.4 (Semantic Candidate Search) - **DONE** - Backend API ready
  - Story 3.6 (Candidate Results Frontend) - **DONE** - Reusable components

- **Related to:**
  - Story 3.5 (JD Upload Frontend) - May share layout/navigation
  - Story 3.8 (CV Visibility) - Search results respect visibility

## Testing

### Frontend Tests
- **Location:** `frontend/features/jobs/components/`
- **Framework:** Jest + React Testing Library
- **Run command:** `npm test -- features/jobs`

### Test Patterns

```typescript
// SearchBar.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { SearchBar } from './SearchBar';

describe('SearchBar', () => {
  it('renders search input and button', () => {
    render(<SearchBar onSearch={jest.fn()} />);
    
    expect(screen.getByRole('searchbox')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /tim kiem/i })).toBeInTheDocument();
  });

  it('calls onSearch when form is submitted', async () => {
    const mockOnSearch = jest.fn();
    render(<SearchBar onSearch={mockOnSearch} />);
    
    const input = screen.getByRole('searchbox');
    fireEvent.change(input, { target: { value: 'Python developer' } });
    fireEvent.submit(screen.getByRole('form'));
    
    expect(mockOnSearch).toHaveBeenCalledWith('Python developer');
  });

  it('has correct ARIA attributes', () => {
    render(<SearchBar onSearch={jest.fn()} />);
    
    expect(screen.getByRole('search')).toBeInTheDocument();
    expect(screen.getByRole('searchbox')).toHaveAttribute('aria-label');
  });
});

// SearchResultList.test.tsx
import { render, screen } from '@testing-library/react';
import { SearchResultList } from './SearchResultList';

const mockResults = [
  {
    cv_id: '123e4567-e89b-12d3-a456-426614174000',
    user_id: 1,
    relevance_score: 85,
    matched_skills: ['python', 'aws'],
    cv_summary: 'Senior developer with cloud experience',
    filename: 'john_doe_cv.pdf',
  },
];

describe('SearchResultList', () => {
  it('renders list of results', () => {
    render(
      <SearchResultList 
        results={mockResults} 
        total={1} 
        loading={false} 
        error={null} 
      />
    );
    
    expect(screen.getByText('john_doe_cv.pdf')).toBeInTheDocument();
    expect(screen.getByText('85')).toBeInTheDocument();
  });

  it('shows empty state when no results', () => {
    render(
      <SearchResultList 
        results={[]} 
        total={0} 
        loading={false} 
        error={null} 
      />
    );
    
    expect(screen.getByText(/khong tim thay/i)).toBeInTheDocument();
  });

  it('shows loading state', () => {
    render(
      <SearchResultList 
        results={[]} 
        total={0} 
        loading={true} 
        error={null} 
      />
    );
    
    expect(screen.getAllByTestId('skeleton-card')).toHaveLength(4);
  });

  it('shows error with retry button', () => {
    render(
      <SearchResultList 
        results={[]} 
        total={0} 
        loading={false} 
        error="Search failed" 
      />
    );
    
    expect(screen.getByText(/search failed/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /thu lai/i })).toBeInTheDocument();
  });
});
```

**[Source: docs/architecture/testing-strategy.md]**

## UI Mockup

### Search Page Layout

```
+-------------------------------------------------------------+
|  <- Back     Tim kiem ung vien                               |
+-------------------------------------------------------------+
|                                                              |
|  +----------------------------------------------------------+|
|  |  [Search icon] Nhap mo ta ung vien ban can tim...   [Tim]||
|  +----------------------------------------------------------+|
|                                                              |
|  (After search)                                              |
|  +----------------------------------------------------------+|
|  | He thong da phan tich query cua ban:                     ||
|  | Ky nang: [Python] [AWS] [Docker]                         ||
|  | Kinh nghiem: "3+ years"                                  ||
|  +----------------------------------------------------------+|
|                                                              |
|  +---------------------------+  +---------------------------+|
|  | Diem toi thieu: 50%      |  | Hien thi: [20 v] / trang  ||
|  | [====o================]  |  +---------------------------+||
|  +---------------------------+                               |
|                                                              |
|  Tim thay 23 ung vien phu hop                               |
|                                                              |
|  +----------------------------------------------------------+|
|  | #1   john_doe.pdf                              [92%]     ||
|  |      Senior Python developer with AWS cert...            ||
|  |      Matched: [Python] [AWS]                             ||
|  |                                           [Xem CV]       ||
|  +----------------------------------------------------------+|
|  | #2   jane_smith.pdf                            [85%]     ||
|  |      Full-stack dev with 4 years experience...           ||
|  |      Matched: [Python] [Docker]                          ||
|  |                                           [Xem CV]       ||
|  +----------------------------------------------------------+|
|                                                              |
|  +----------------------------------------------------------+|
|  |   [<< Prev]   Trang 1 / 2   [Next >>]                   ||
|  +----------------------------------------------------------+|
|                                                              |
+-------------------------------------------------------------+
```

### Mobile Layout (375px)

```
+---------------------------+
| <- Tim kiem ung vien      |
+---------------------------+
|                           |
| [Search input...    ] [Q] |
|                           |
| Ky nang tim kiem:         |
| [Python] [AWS] +1         |
|                           |
| Diem toi thieu: [50%]     |
| Hien thi: [20 v]          |
+---------------------------+
| 23 ung vien phu hop       |
+---------------------------+
| #1            [92%]       |
| john_doe.pdf              |
| Senior Python dev...      |
|                           |
| [Python] [AWS]            |
|                           |
| [     Xem CV     ]        |
+---------------------------+
| #2            [85%]       |
| ...                       |
+---------------------------+
| [Prev] 1/2 [Next]         |
+---------------------------+
```

### Empty State

```
+-------------------------------------------------------------+
|  +----------------------------------------------------------+|
|  |  [Search icon] Python developer with Kubernetes  [Tim]   ||
|  +----------------------------------------------------------+|
|                                                              |
|  +----------------------------------------------------------+|
|  |     [No results illustration]                            ||
|  |                                                          ||
|  |     Khong tim thay ung vien phu hop                      ||
|  |                                                          ||
|  |     Thu:                                                 ||
|  |     - Su dung cac tu khoa khac                           ||
|  |     - Giam diem toi thieu                                ||
|  |     - Mo rong pham vi ky nang                            ||
|  +----------------------------------------------------------+|
+-------------------------------------------------------------+
```

**[Source: docs/prd/3-candidate-discovery-epic.md#3.3]**

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-18 | 1.0 | Initial draft of Story 3.7 - Semantic Search Frontend | Bob (Scrum Master) |
| 2025-12-18 | 1.1 | PO validation: Added Task 10 for `/jobs/candidates/[cvId]` route, updated AC5, renumbered tasks 11-13 | Sarah (PO) |
| 2025-12-19 | 1.2 | QA Review: Story passes quality gate with all required ACs validated | Quinn (QA) |

---

## QA Results

### Requirements Traceability Matrix

| AC # | Requirement | Test Coverage | Status |
|:-----|:------------|:--------------|:-------|
| AC1 | Search page at `/jobs/search` | `SearchPage` route exists with auth guard; verified in build output | PASS |
| AC2 | Natural language query support | `SearchBar.test.tsx`: 14 tests covering input, submission, validation (min 2 chars) | PASS |
| AC3 | Display results with relevance scores (0-100) | `SearchResultCard.test.tsx`: Tests score badge rendering with color coding (lines 45-51, 132-153) | PASS |
| AC4 | Show candidate preview (filename, summary, matched skills) | `SearchResultCard.test.tsx`: Tests filename display (30-37), summary truncation (83-107), skill badges (53-59) | PASS |
| AC5 | Link to CV profile at `/jobs/candidates/{cvId}` | `SearchResultCard.test.tsx` (61-69), `SearchResultList.test.tsx` (168-179): Link verification tests | PASS |
| AC6 | Pagination support | `SearchResultList.test.tsx`: Pagination rendering (140-145), offset-based ranking (118-131) | PASS |
| AC7 | Min score filtering | `SearchResultList.test.tsx`: MinScoreFilter rendering (133-138); `SemanticSearchPage.tsx` handles state | PASS |
| AC8 | Parsed query interpretation display | `ParsedQueryDisplay.test.tsx`: 7 tests for skills, experience, collapsible raw query | PASS |
| AC9 | Empty state | `SearchResultList.test.tsx` (72-81): Empty state with suggestions rendered | PASS |
| AC10 | Loading state with skeleton cards | `SearchResultList.test.tsx` (83-88): 4 skeleton cards rendered during loading | PASS |
| AC11 | Error handling with retry button | `SearchResultList.test.tsx` (90-116): Error message and retry button tests | PASS |
| AC12 | Responsive design | Code review: Tailwind responsive classes (`sm:`, `flex-col sm:flex-row`) in all components | PASS |
| AC13 | Accessibility (ARIA, keyboard) | `SearchBar.test.tsx` (119-125): ARIA attributes; all components have `role`, `aria-label` | PASS |
| AC14 | Unit tests for components | 46 tests across 4 test files, all passing | PASS |
| AC15 | Search history (optional) | Not implemented - documented as nice-to-have | N/A |

**Coverage Summary:** 14/14 required ACs validated; 1 optional AC deferred.

### Code Quality Assessment

#### Architecture & Design Patterns
| Aspect | Assessment | Notes |
|:-------|:-----------|:------|
| Component Structure | EXCELLENT | Clean separation: SearchBar, ParsedQueryDisplay, SearchResultCard, SearchResultList, SemanticSearchPage |
| Component Reuse | EXCELLENT | Correctly reuses MatchScoreBadge, SkillBadges, CandidatePagination, MinScoreFilter from Story 3.6 |
| State Management | GOOD | Proper useState/useCallback pattern in SemanticSearchPage; state lifted appropriately |
| Type Safety | EXCELLENT | Full TypeScript with shared types from `@datn/shared-types` |
| Error Handling | EXCELLENT | Comprehensive error states with retry mechanism; specific error codes (PRIVATE, NOT_FOUND) |

#### Code Quality Metrics
- **Test Coverage:** 46 unit tests covering all new components
- **Build Status:** Successful - all routes registered correctly
- **Type Errors:** None detected
- **Linting:** No violations observed in reviewed code

### NFR Validation

#### Security
| Check | Status | Evidence |
|:------|:-------|:---------|
| Auth Guard on routes | PASS | `page.tsx:14-21` - Token check with redirect to `/login` |
| Token handling | PASS | Server-side only via `cookies()` from `next/headers` |
| No client-side token access | PASS | All auth logic in Server Components/Actions |
| Input validation | PASS | Zod schema validation in `actions.ts:432-437` |

#### Performance
| Check | Status | Evidence |
|:------|:-------|:---------|
| Loading states | PASS | Skeleton cards during API calls |
| Pagination | PASS | Server-side pagination (limit/offset) |
| Debounced input | PARTIAL | Not implemented - manual submit button used instead |
| State optimization | PASS | useCallback for memoized handlers |

#### Reliability
| Check | Status | Evidence |
|:------|:-------|:---------|
| Error handling | PASS | Try-catch in all actions; user-friendly messages |
| Retry mechanism | PASS | Retry button in error state |
| Graceful degradation | PASS | Empty state with suggestions; private CV handling |

#### Maintainability
| Check | Status | Evidence |
|:------|:-------|:---------|
| Code clarity | EXCELLENT | Clear naming, well-structured components |
| Documentation | GOOD | JSDoc on server actions |
| Component modularity | EXCELLENT | Single-responsibility components |

### Accessibility Compliance

| Requirement | Implementation | Status |
|:------------|:---------------|:-------|
| `role="search"` | SearchBar form element | PASS |
| `aria-label` on inputs | SearchBar input, buttons | PASS |
| `role="list"` / `role="listitem"` | SearchResultList, SearchResultCard | PASS |
| Keyboard navigation | Escape to clear, Enter to submit | PASS |
| Loading state announcement | `aria-label="Dang tai ket qua"` | PASS |
| Screen reader support | Descriptive labels on all interactive elements | PASS |

### Compliance Check

| Standard | Status | Notes |
|:---------|:-------|:------|
| Coding Standards | PASS | Follows project conventions (API through service layer, shared types, cookie security) |
| Project Structure | PASS | Components in `features/jobs/components/`, routes in `app/jobs/` |
| Testing Strategy | PASS | Jest + React Testing Library; mocked dependencies |
| All Required ACs Met | PASS | 14/14 ACs validated |

### Improvements Checklist

| Priority | Improvement | Status |
|:---------|:------------|:-------|
| Low | Add debounce for auto-search (optional per story) | Deferred |
| Low | Implement search history (AC15 - nice-to-have) | Deferred |
| None | No critical improvements required | - |

### Security Review Summary

- Authentication properly enforced on all routes
- No sensitive data exposed in client code
- Input validation with Zod prevents injection attacks
- Error messages don't leak internal details

### Performance Review Summary

- Skeleton loading provides good UX during API calls
- Server-side pagination prevents large data transfers
- Component memoization with useCallback reduces re-renders
- No performance concerns identified

### Gate Status

| Gate | Decision | Rationale |
|:-----|:---------|:----------|
| **Quality Gate** | **PASS** | All 14 required ACs validated with comprehensive test coverage (46 tests). Code follows project standards. NFRs satisfied. |

### Recommendations

1. **Ready for Done** - Story meets all acceptance criteria and quality standards
2. **Optional Enhancement** - Consider implementing search history (AC15) in future iteration
3. **No Blockers** - Code is production-ready
