# Story 3.4: Semantic Candidate Search

## Status
Ready for Review

## Story
**As a** Talent Seeker,
**I want** to search candidates using natural language,
**So that** I can find relevant profiles without uploading a full JD.

## Acceptance Criteria

1. Implement semantic search endpoint: POST `/api/v1/jobs/search`
2. Accept natural language query (e.g., "Python developer with AWS experience")
3. Parse query to extract search criteria (skills, experience, keywords)
4. Match against CV skills and content using both skill-based and semantic matching
5. Return top N candidates with relevance scores
6. Handle various query formats gracefully
7. Support pagination (limit, offset parameters)
8. Support minimum score filtering (min_score parameter)
9. Unit tests for SemanticSearcher class
10. Integration tests for /search endpoint

## Tasks / Subtasks

- [x] **Task 1: Create SemanticSearcher Class (AC: 3, 4, 5)**
    - [x] Create file `backend/app/modules/jobs/semantic_searcher.py`
    - [x] Define `SemanticSearcher` class with module-level instance pattern (like CandidateRanker)
    - [x] Implement `async def search_candidates(query, db, limit, offset, min_score) -> tuple[list[SearchResult], int]`
    - [x] Implement `_parse_query(query) -> ParsedQuery` to extract skills/experience from natural language
    - [x] Implement `_calculate_relevance(parsed_query, cv_analysis) -> SearchResult`
    - [x] Implement `_skill_match_score(query_skills, cv_skills) -> float` (0-70 points)
    - [x] Implement `_keyword_match_score(query_keywords, cv_content) -> float` (0-30 points)
    - [x] Use `SkillExtractor` from `app.modules.ai.skill_extractor` for skill extraction from query

- [x] **Task 2: Create Pydantic Schemas for Search (AC: 1, 5, 7, 8)**
    - [x] Update `backend/app/modules/jobs/schemas.py`
    - [x] Create `SemanticSearchRequest` schema (query: str, limit: int, offset: int, min_score: int)
    - [x] Create `ParsedQueryResponse` schema (extracted_skills, experience_keywords, raw_query)
    - [x] Create `SearchResultResponse` schema (cv_id, user_id, relevance_score, matched_skills, cv_summary, filename)
    - [x] Create `SearchResultListResponse` schema (items, total, limit, offset, parsed_query)

- [x] **Task 3: Create API Endpoint (AC: 1, 2, 6, 7, 8)**
    - [x] Add POST `/api/v1/jobs/search` endpoint in `router.py`
    - [x] Accept JSON body with `query` (required), `limit` (default 20), `offset` (default 0), `min_score` (default 0)
    - [x] Require authentication
    - [x] Return 400 for empty/invalid query or query shorter than 2 characters
    - [x] Return search results with pagination info

- [x] **Task 4: Query Parsing with LLM (AC: 3, 6)**
    - [x] Create `_parse_query_with_llm(query) -> ParsedQuery` in `semantic_searcher.py`
    - [x] Use existing LLM service pattern from `jd_parser.py`
    - [x] Extract: skills (required and nice-to-have), min_experience_years, keywords
    - [x] Fallback to rule-based parsing if LLM unavailable
    - [x] Handle Vietnamese and English queries

- [x] **Task 5: Implement Hybrid Matching Algorithm (AC: 4, 5)**
    - [x] Combine skill-based matching (using SkillExtractor normalization)
    - [x] Add keyword matching against CV summary/content
    - [x] Optional: Use embeddings for semantic similarity if available
    - [x] Calculate final relevance_score (0-100)

- [x] **Task 6: Write Unit Tests (AC: 9)**
    - [x] Create `backend/tests/modules/jobs/test_semantic_searcher.py`
    - [x] `TestParseQuery` - Test query parsing with various formats
    - [x] `TestSkillMatchScore` - Test skill matching calculation
    - [x] `TestKeywordMatchScore` - Test keyword matching
    - [x] `TestCalculateRelevance` - Test full relevance calculation
    - [x] `TestSearchCandidates` - Test search with mocked DB

- [x] **Task 7: Write Integration Tests (AC: 10)**
    - [x] Update `backend/tests/modules/jobs/test_job_router.py`
    - [x] `test_search_candidates_success` - Basic search returns results
    - [x] `test_search_candidates_with_pagination` - Verify limit/offset works
    - [x] `test_search_candidates_with_min_score` - Verify min_score filtering
    - [x] `test_search_candidates_empty_query` - 400 for empty query
    - [x] `test_search_candidates_no_results` - Empty list when no matches
    - [x] `test_search_candidates_unauthenticated` - 401 without auth

## Dev Notes

### Previous Story Insights (Story 3.3)

From Story 3.3 implementation:
- `CandidateRanker` class uses skill overlap and experience scoring
- Scoring algorithm: 70% skill score + 30% experience score
- Uses `SkillExtractor` for skill normalization
- Pagination: default limit 20, max 100
- CV data from `CVAnalysis` model includes `extracted_skills`, `ai_summary`

**[Source: docs/stories/3.3.story.md#Dev-Notes]**

### Existing Infrastructure

From Story 3.2 and jobs module:
- `JDParser` extracts skills from JD text using LLM
- `SkillExtractor` normalizes skills using taxonomy
- `EmbeddingService` generates embeddings for semantic search (optional enhancement)
- `candidate_ranker.py` provides reference for CV matching logic

**[Source: backend/app/modules/jobs/jd_parser.py, backend/app/modules/ai/skill_extractor.py]**

### CV Analysis Data Structure

From `CVAnalysis` model:
```python
class CVAnalysis:
    cv_id: UUID
    status: AnalysisStatus  # PENDING, PROCESSING, COMPLETED, FAILED
    ai_score: int | None  # Overall CV quality score
    ai_summary: str | None  # Text summary
    extracted_skills: list[str] | None  # Flat list of skills
    skill_categories: dict | None  # Skills by category
```

**Accessing CV relationship:** Use `cv_analysis.cv.user_id` and `cv_analysis.cv.filename` to get user and file info (requires `selectinload(CVAnalysis.cv)` in query).

**[Source: backend/app/modules/ai/models.py]**

### API Request/Response Schema

**Request (POST /api/v1/jobs/search):**
```json
{
  "query": "Python developer with 3 years AWS experience",
  "limit": 20,
  "offset": 0,
  "min_score": 0
}
```

**Response:**
```json
{
  "items": [
    {
      "cv_id": "uuid",
      "user_id": 1,
      "relevance_score": 85,
      "matched_skills": ["python", "aws"],
      "cv_summary": "Senior Python developer...",
      "filename": "john_doe_cv.pdf"
    }
  ],
  "total": 15,
  "limit": 20,
  "offset": 0,
  "parsed_query": {
    "extracted_skills": ["python", "aws"],
    "experience_keywords": ["3 years"],
    "raw_query": "Python developer with 3 years AWS experience"
  }
}
```

### Query Parsing Strategy

1. **Rule-based extraction (primary):**
   - Use `SkillExtractor.extract_skills_flat()` to get skills from query
   - Extract experience patterns: "X years", "X+ years", "X năm"
   - Extract role keywords: "developer", "engineer", "senior", etc.

2. **LLM-enhanced extraction (optional):**
   - Use LLM to extract structured requirements from natural language
   - Similar prompt structure to `JDParser`
   - Fallback to rule-based if LLM fails

### Matching Algorithm Design

**Relevance Score Calculation (0-100):**

1. **Skill Match Score (70% weight):**
   - Matched skill ratio: `matched / total_query_skills`
   - Formula: `(matched_skills / query_skills) * 70`
   - If no skills in query, default to 35 (neutral)

2. **Keyword/Content Score (30% weight):**
   - Check CV summary for query keywords
   - Experience level matching bonus
   - Formula: `keyword_matches * weight + experience_bonus`

3. **Final Score:** `skill_score + keyword_score` (clamped to 0-100)

### File Locations

**Files to Create:**
```
backend/app/modules/jobs/
└── semantic_searcher.py    # NEW: SemanticSearcher class

backend/tests/modules/jobs/
└── test_semantic_searcher.py  # NEW: Searcher unit tests
```

**Files to Modify:**
```
backend/app/modules/jobs/
├── schemas.py             # Add search schemas
└── router.py              # Add /search endpoint

backend/tests/modules/jobs/
└── test_job_router.py     # Add search endpoint tests
```

**[Source: docs/architecture/source-tree.md]**

### Technical Constraints

1. **Performance:**
   - Use SQLAlchemy eager loading for CV analyses
   - Pagination is mandatory (default limit: 20, max: 100)
   - Consider caching parsed queries

2. **Authorization:**
   - Search endpoint requires authentication
   - Returns all public CVs (or CVs where is_public=true if implemented)

3. **Error Handling:**
   - Return 400 for empty or whitespace-only query
   - Return empty list if no CVs match criteria
   - Handle cases where CV analysis is pending/failed (skip them)

4. **Query Handling:**
   - Support both Vietnamese and English queries
   - Handle special characters gracefully
   - Minimum query length: 2 characters

**[Source: docs/architecture/coding-standards.md]**

### Dependencies

- **Story 3.4 depends on:**
  - Story 3.1 (JD Module Foundation) - **DONE**
  - Story 3.2 (JD Parsing) - **DONE** - Provides `SkillExtractor` usage patterns
  - Story 3.3 (Candidate Ranking) - **DONE** - Provides `CandidateRanker` reference
  - Epic 2 (CV Analysis) - CV model with extracted_skills available

- **Stories that depend on 3.4:**
  - Story 3.7 (Search Frontend) - Uses search API

## Testing

### Backend Tests
- **Location:** `backend/tests/modules/jobs/`
- **Framework:** `pytest` with async support (`pytest-asyncio`)
- **Test Client:** `httpx.AsyncClient` for API tests

### Test Patterns

```python
# Example: test_semantic_searcher.py
import pytest
from app.modules.jobs.semantic_searcher import SemanticSearcher

@pytest.fixture
def searcher():
    return SemanticSearcher()

def test_parse_query_extracts_skills(searcher):
    query = "Python developer with AWS experience"
    result = searcher._parse_query(query)
    
    assert "python" in result.extracted_skills
    assert "aws" in result.extracted_skills

def test_parse_query_extracts_experience(searcher):
    query = "Senior developer with 5 years experience"
    result = searcher._parse_query(query)
    
    assert "5 years" in result.experience_keywords or result.min_experience == 5

def test_skill_match_score_all_matched(searcher):
    query_skills = ["python", "aws"]
    cv_skills = ["python", "aws", "docker", "postgresql"]
    
    score = searcher._skill_match_score(query_skills, cv_skills)
    
    assert score == 70.0  # Full skill score

def test_skill_match_score_partial(searcher):
    query_skills = ["python", "aws", "kubernetes"]
    cv_skills = ["python", "aws"]
    
    score = searcher._skill_match_score(query_skills, cv_skills)
    
    assert score == pytest.approx(46.67, rel=0.1)  # 2/3 * 70

@pytest.mark.asyncio
async def test_search_candidates_returns_ranked_results(searcher, mock_db):
    results, total = await searcher.search_candidates(
        query="Python developer",
        db=mock_db,
        limit=10,
        offset=0,
        min_score=0
    )
    
    assert len(results) <= 10
    # Results should be sorted by relevance_score descending
    for i in range(len(results) - 1):
        assert results[i].relevance_score >= results[i + 1].relevance_score
```

**[Source: docs/architecture/testing-strategy.md]**

## Dev Agent Record

### Completion Notes

Story 3.4 implementation completed successfully. The semantic candidate search feature allows users to find candidates using natural language queries (e.g., "Python developer with AWS experience") without uploading a full job description.

**Key Implementation Details:**
- `SemanticSearcher` class follows the module-level singleton pattern established by `CandidateRanker`
- Hybrid matching algorithm: 70% skill match score + 30% keyword match score
- LLM-enhanced query parsing with fallback to rule-based parsing
- Supports both Vietnamese and English queries
- Full pagination support with `limit`, `offset`, and `min_score` filtering

**Test Coverage:**
- 35 unit tests in `test_semantic_searcher.py` covering all core functionality
- 12 integration tests in `test_job_router.py` for the `/search` endpoint
- All 161 tests in jobs module passing

### File List

**New Files:**
| File | Description |
| :--- | :--- |
| `backend/app/modules/jobs/semantic_searcher.py` | SemanticSearcher class with query parsing and candidate matching |
| `backend/tests/modules/jobs/test_semantic_searcher.py` | Unit tests for SemanticSearcher (35 tests) |

**Modified Files:**
| File | Description |
| :--- | :--- |
| `backend/app/modules/jobs/schemas.py` | Added SemanticSearchRequest, ParsedQueryResponse, SearchResultResponse, SearchResultListResponse |
| `backend/app/modules/jobs/router.py` | Added POST `/api/v1/jobs/search` endpoint |
| `backend/tests/modules/jobs/test_job_router.py` | Added TestSearchCandidatesEndpoint class (12 tests) |

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-18 | 1.0 | Initial draft of Story 3.4 - Semantic Candidate Search | Bob (Scrum Master) |
| 2025-12-18 | 1.1 | PO validation: Fixed Task 1 pattern, Task 3 validation, added CV relationship note | Sarah (PO) |
| 2025-12-18 | 1.2 | Implementation complete: All 7 tasks done, 47 tests passing | Dev Agent |
