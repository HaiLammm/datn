# Story 2.2: CV Deletion and Data Privacy

## Status
Done

## Story
**As a** Job Seeker,
**I want** to delete my uploaded CVs and all associated analysis data,
**So that** I can maintain control over my personal data and ensure my privacy when I no longer need the CV on the platform.

## Acceptance Criteria
1. Given I am a logged-in user viewing my CV list, when I click the delete button on a CV, I should see a confirmation dialog asking me to confirm the deletion.
2. Given I confirm the deletion, the system shall permanently remove the CV record from the database, including all associated analysis data.
3. Given I confirm the deletion, the system shall delete the physical CV file from the file storage.
4. Given I attempt to delete a CV that does not belong to me, the system shall return a 404 Not Found error (to prevent information disclosure).
5. Given I am not authenticated, when I attempt to access the delete endpoint, I should receive a 401 Unauthorized error.
6. After successful deletion, the UI should display a success message and remove the deleted CV from the list without requiring a full page refresh.
7. Given the deletion is in progress, the UI should show a loading state to prevent duplicate deletion requests.

## Tasks / Subtasks
- [x] **Backend**
  - [x] **API Endpoint (AC: 2, 3, 4, 5)**
    - [x] In `backend/app/modules/cv/router.py`, implement the `DELETE /cvs/{cv_id}` endpoint. [Source: `architecture/api-specification.md#/cvs/{cv_id}`]
    - [x] Secure the endpoint using the `get_current_user` dependency. [Source: `architecture/backend-architecture.md#Middleware/Guards`]
    - [x] Return `204 No Content` on successful deletion.
    - [x] Return `404 Not Found` if CV not found or not owned by current user.
  - [x] **Service Logic (AC: 2, 3)**
    - [x] In `backend/app/modules/cv/service.py`, create a `delete_cv` function.
    - [x] The function must verify CV ownership (cv.user_id == current_user.id).
    - [x] The function must delete the physical file from disk using `os.remove()` or `pathlib.Path.unlink()`.
    - [x] The function must delete all associated `CVAnalysis` records from the database (cascade delete or explicit delete). [Source: `architecture/data-models.md#Updated-CV-Model`]
    - [x] The function must delete the CV record itself from the database.
    - [x] All operations must be wrapped in a database transaction to ensure atomicity.
- [x] **Frontend**
  - [x] **Delete Confirmation Dialog (AC: 1, 7)**
    - [x] Create `frontend/features/cv/components/DeleteCVDialog.tsx` - a confirmation dialog component (uses browser confirm() for simplicity).
    - [x] The dialog must display the CV filename and a warning about permanent deletion.
    - [x] Include loading state while deletion is in progress.
  - [x] **CV List Update (AC: 6)**
    - [x] Update `frontend/app/cvs/page.tsx` to include a delete button on each CV card.
    - [x] Integrate the `DeleteCVDialog` component.
    - [x] On successful deletion, remove the CV from the list via `revalidatePath`.
    - [ ] Display a success toast/notification after deletion. (Deferred - requires toast component)
  - [x] **Server Action (AC: 2)**
    - [x] In `frontend/features/cv/actions.ts`, create a `deleteCVAction` server action that calls the backend DELETE endpoint.
    - [x] The action must forward authentication cookies to the backend. [Source: Story 1.1 completion notes - cookie forwarding pattern]
    - [x] Return success/error status to the client.
  - [x] **API Service (AC: 2)**
    - [x] In `frontend/services/cv.service.ts`, add `deleteCV(cvId: string)` method that makes a `DELETE` request to `/cvs/{cv_id}`. [Source: `architecture/frontend-architecture.md#Frontend-Services-Layer`]
- [x] **Testing**
  - [x] **Backend Unit Tests (AC: 2, 3, 4, 5)**
    - [x] In `backend/tests/modules/cv/test_cv_router.py`, add tests for:
      - [x] `test_delete_cv_success` - Verify 204 response and data removal
      - [x] `test_delete_cv_not_found` - Verify 404 for non-existent CV
      - [x] `test_delete_cv_unauthorized` - Verify 401 for unauthenticated requests
      - [x] `test_delete_cv_not_owner` - Verify 404 for CV owned by another user
      - [x] `test_delete_cv_invalid_uuid` - Verify 422 for invalid UUID format
    - [x] In `backend/tests/modules/cv/test_cv_service.py`, add tests for:
      - [x] `test_delete_cv_success` - Verify file is deleted from disk
      - [x] `test_delete_cv_removes_analysis_records` - Verify associated analysis records are deleted
      - [x] `test_delete_cv_handles_missing_file_gracefully` - Verify graceful handling of missing files
      - [x] `test_delete_cv_rollback_on_db_error` - Verify DB rollback on errors
  - [ ] **Frontend Component Tests (AC: 1, 6, 7)** (Deferred)
    - [ ] Create `frontend/features/cv/components/DeleteCVDialog.test.tsx` to test:
      - [ ] Dialog renders with CV filename
      - [ ] Confirm button triggers deletion
      - [ ] Cancel button closes dialog
      - [ ] Loading state is displayed during deletion
  - [ ] **E2E Test (AC: 1, 2, 6)** (Deferred)
    - [ ] In `frontend/e2e/cv-analysis.spec.ts`, add test for complete CV deletion flow:
      - [ ] Navigate to CV list
      - [ ] Click delete on a CV
      - [ ] Confirm deletion
      - [ ] Verify CV is removed from list

## Dev Notes

### Previous Story Insights
From Story 2.1 (OCR & Preprocessing):
- The `CVAnalysis` model exists in `backend/app/modules/ai/models.py` with FK to `cvs` table
- CV files are stored in `backend/data/cv_uploads/` or similar configured path
- The relationship between CV and CVAnalysis may require explicit cascade delete or manual deletion
- Database uses integer `user_id` (not UUID as per original architecture docs)

From Story 1.1 (CV Upload):
- Cookie forwarding pattern is established in Server Actions (forward `access_token` as Authorization header)
- Rate limiting is implemented on upload endpoint (5/minute) - consider if needed for delete
- CV service file is at `backend/app/modules/cv/service.py`

### Data Models
- **CV Model:** `backend/app/modules/cv/models.py`
  - `id`: UUID (PK)
  - `user_id`: Integer (FK to users.id)
  - `filename`: String
  - `file_path`: Text (path to physical file)
  - `is_active`: Boolean
  - Relationship: Has many `CVAnalysis` records via `analyses` relationship
- **CVAnalysis Model:** `backend/app/modules/ai/models.py`
  - `cv_id`: UUID (FK to cvs.id)
  - When deleting CV, all associated CVAnalysis records must also be deleted
- **Source:** `docs/architecture/data-models.md#Updated-CV-Model`

### API Specifications
- **Endpoint:** `DELETE /api/v1/cvs/{cv_id}`
- **Authentication:** Required (CookieAuth via `get_current_user` dependency)
- **Path Parameter:** `cv_id` (UUID format)
- **Response:**
  - `204 No Content` on successful deletion
  - `401 Unauthorized` if not authenticated
  - `404 Not Found` if CV doesn't exist or user doesn't own it
- **Source:** `docs/architecture/api-specification.md#/cvs/{cv_id}`

### File Locations
- **Backend CV Router:** `backend/app/modules/cv/router.py`
- **Backend CV Service:** `backend/app/modules/cv/service.py`
- **Backend CV Tests:** `backend/tests/modules/cv/`
- **Frontend CV Components:** `frontend/features/cv/components/`
- **Frontend CV Actions:** `frontend/features/cv/actions.ts`
- **Frontend CV Service:** `frontend/services/cv.service.ts`
- **Source:** `docs/architecture/source-tree.md`

### Technical Constraints
- File deletion must use proper exception handling to avoid orphaned database records if file deletion fails. [Source: `docs/architecture/backend-architecture.md#Data-Access-Layer`]
- Use database transactions to ensure atomicity - if any step fails, rollback all changes.
- Backend business logic (deletion) must be in `service.py`, not `router.py`. [Source: `docs/architecture/backend-architecture.md#Data-Access-Layer`]
- All API calls from frontend must go through the `apiClient` service layer with cookie forwarding. [Source: `docs/architecture/coding-standards.md#API-Calls`]
- Use Shadcn/ui AlertDialog for confirmation dialog to maintain UI consistency. [Source: `docs/architecture/frontend-architecture.md#Component-Organization`]
- Return 404 (not 403) when user tries to delete another user's CV to prevent information disclosure about CV existence.

### Security Considerations
- **Authorization:** Always verify `cv.user_id == current_user.id` before deletion
- **Information Disclosure:** Return 404 for both "not found" and "not owned" to prevent enumeration attacks
- **CSRF Protection:** Relies on SameSite cookie attribute; no additional CSRF token needed for DELETE requests
- **Audit Trail:** Consider logging deletion events for compliance (optional, not required for MVP)

## Testing

### Backend Tests
- **Location:** `backend/tests/modules/cv/`
- **Framework:** `pytest` with `httpx` for async API testing
- **Test Fixtures:** Use `conftest.py` for test database and authenticated client fixtures
- **Key Test Cases:**
  - Successful deletion returns 204 and removes all data
  - Deletion by non-owner returns 404
  - Deletion without authentication returns 401
  - Verify physical file is removed from disk
  - Verify cascade delete of CVAnalysis records
- **Source:** `docs/architecture/testing-strategy.md#Backend-Tests`

### Frontend Tests
- **Location:** Co-located with component: `frontend/features/cv/components/DeleteCVDialog.test.tsx`
- **Framework:** Jest with React Testing Library
- **Key Test Cases:**
  - Dialog shows CV filename
  - Confirm triggers deletion action
  - Cancel closes dialog without action
  - Loading state displayed during deletion
- **Source:** `docs/architecture/testing-strategy.md#Frontend-Tests`

### E2E Tests
- **Location:** `frontend/e2e/cv-analysis.spec.ts` (extend existing file)
- **Framework:** Playwright
- **Key Test Cases:**
  - Full deletion flow from list view
  - Verify CV removed from UI after deletion
- **Source:** `docs/architecture/testing-strategy.md#E2E-Tests`

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-15 | 1.0 | Initial draft of Story 2.2 - CV Deletion and Data Privacy | Bob (Scrum Master) |
