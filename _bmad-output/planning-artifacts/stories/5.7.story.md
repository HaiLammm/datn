# Story 5.7: Implement Enhanced Scoring and Job Match Score

## Status
Done

## Story
**As a** Recruiter,
**I want** to see a specific "Job Match Score" for each candidate that prioritizes relevance to my Job Description,
**So that** I can quickly identify the most relevant applicants, independent of their "general" CV quality.

**As a** System,
**I want** the general skill scoring to be more nuanced,
**So that** I can account for the changing value of technologies over time and better evaluate senior candidates.

## Acceptance Criteria

### Backend
1.  The `skill_taxonomy.py` file is updated to include a versioned dictionary for "hot skills" (e.g., `HOT_SKILLS_2023`, `HOT_SKILLS_2024`).
2.  The `_calculate_market_relevance` method in `skill_scorer.py` is updated to check a skill against multiple years of hot skill lists.
3.  The LLM prompt for CV analysis is enhanced to give more weight to leadership roles and years of experience.
4.  A new endpoint `POST /api/v1/jobs/{job_id}/match` is created that takes a CV ID and returns a specific job match score.
5.  The "Job Match Score" calculation prioritizes skills listed in the JD over general "hot skills".

### Frontend
6.  The "Candidate Results" page (`/jobs/jd/[jdId]/candidates`) displays the new "Job Match Score" for each candidate.
7.  The "Job Match Score" is displayed prominently on the `CandidateCard` component with clear color-coding (e.g., Green for high match, Yellow for medium, Red for low).
8.  The UI gracefully handles cases where the match score has not yet been calculated.

### Testing
9.  Unit and integration tests are created for the new backend logic (versioned hot skills, job match endpoint).
10. Frontend component tests are updated to verify the display of the new "Job Match Score".
11. E2E tests validate the end-to-end flow of viewing matched candidates with their job-specific scores.

## Dev Notes

### Previous Story Insights
- **Story 5.2 (Hybrid Skill Scorer):** Introduced `SkillScorer` and the concept of `market_relevance_score`. This story will modify that logic. [Source: `docs/stories/5.2.story.md`]
- **Story 3.3 (Candidate Ranking):** Implemented the initial candidate ranking. This story introduces a more sophisticated, context-aware score. [Source: `docs/stories/3.3.story.md`]
- **Story 3.6 (Candidate Results Frontend):** Created the `CandidateCard.tsx` and the candidates list page where the new score will be displayed. [Source: `docs/stories/3.6.story.md`]

### Data Models
- No direct database schema changes are required. This story modifies existing logic and adds a new, non-persistent calculation endpoint.
- The `skill_taxonomy.py` file will be modified to include new data structures.
- [Source: `docs/architecture/data-models.md`]

### API Specifications

**New Endpoint:**
`POST /api/v1/jobs/{job_id}/match`
- **Request Body:** `{ "cv_id": "string" }`
- **Authorization:** Required (Recruiter role)
- **Action:** Calculates the `skill_match_rate` from the `SkillMatcher` and potentially other factors to return a comprehensive job match score.
- **Response:**
  ```json
  {
    "cv_id": "string",
    "job_id": "string",
    "job_match_score": 88
  }
  ```
- [Source: `docs/prd/5-hybrid-skill-scoring-epic.md` Story 5.7 Technical Notes]

### File Locations
- **Backend:**
  - `backend/app/modules/ai/skill_taxonomy.py` (Modify)
  - `backend/app/modules/ai/skill_scorer.py` (Modify)
  - `backend/app/modules/jobs/router.py` (Modify: add new endpoint)
  - `backend/app/modules/jobs/services.py` (Modify: add new service logic)
  - `backend/tests/modules/ai/test_skill_scorer.py` (Modify)
  - `backend/tests/modules/jobs/test_job_router.py` (Modify)
- **Frontend:**
  - `frontend/features/jobs/components/CandidateCard.tsx` (Modify)
  - `frontend/app/jobs/jd/[jdId]/candidates/page.tsx` (Modify)
- [Source: `docs/architecture/source-tree.md`]

### Technical Constraints
- The versioned hot skills logic must be additive; a skill is considered "hot" if it appears in any of the checked years' lists.
- The new `match` endpoint should be performant and not require saving new data to the database.
- Frontend components must handle the state where the `job_match_score` is not yet available.
- [Source: `docs/prd/5-hybrid-skill-scoring-epic.md` Story 5.7]

### Testing

#### Test Framework and Location
- **Backend Framework:** `pytest` with `httpx.AsyncClient` for API tests
- **Frontend Framework:** Jest with React Testing Library
- **E2E Framework:** Playwright

#### Test File Locations
- **Backend Unit Tests:** `backend/tests/modules/ai/test_skill_scorer.py` (modify existing)
- **Backend Integration Tests:** `backend/tests/modules/jobs/test_job_router.py` (modify existing)
- **Frontend Component Tests:** `frontend/features/jobs/components/CandidateCard.test.tsx` (modify existing)
- **E2E Tests:** `frontend/e2e/job-match-score.spec.ts` (new file)

#### Test Scenarios Required

**Backend Unit Tests (Task 4):**
- `test_calculate_market_relevance_multi_year` - Verify skill found in 2023 OR 2024 is counted
- `test_calculate_market_relevance_single_year_only` - Verify skill in only one year works
- `test_hot_skills_versions_structure` - Verify HOT_SKILLS_VERSIONS dict is correct

**Backend Integration Tests (Task 7):**
- `test_job_match_endpoint_success` - Valid request returns job_match_score
- `test_job_match_endpoint_unauthorized` - Non-recruiter gets 403
- `test_job_match_endpoint_job_not_found` - Invalid job_id returns 404
- `test_job_match_endpoint_cv_not_found` - Invalid cv_id returns 404

**Frontend Component Tests (Task 11):**
- `test_candidate_card_displays_job_match_score` - Score is rendered
- `test_candidate_card_color_coding_green` - Score >= 70 shows green
- `test_candidate_card_color_coding_yellow` - Score 40-69 shows yellow
- `test_candidate_card_color_coding_red` - Score < 40 shows red
- `test_candidate_card_loading_state` - Loading spinner when score is null

**E2E Tests (Task 12):**
- `test_candidates_page_shows_job_match_scores` - All candidates have scores displayed
- `test_job_match_score_color_coding_visible` - Visual verification of color badges

#### Run Commands
```bash
# Backend tests
pytest backend/tests/modules/ai/test_skill_scorer.py -v -k "market_relevance"
pytest backend/tests/modules/jobs/test_job_router.py -v -k "match"

# Frontend tests
npm test -- --testPathPattern="CandidateCard"

# E2E tests
npx playwright test job-match-score.spec.ts
```

[Source: `docs/architecture/testing-strategy.md`, `docs/architecture/tech-stack.md`]

## Tasks / Subtasks

- [x] **Backend - Skill Scoring Enhancement**
  - [x] **Task 1 (AC: 1):** In `skill_taxonomy.py`, add `HOT_SKILLS_2023` and a `HOT_SKILLS_VERSIONS` dictionary. [Source: `docs/prd/5-hybrid-skill-scoring-epic.md` Story 5.7 Technical Notes]
  - [x] **Task 2 (AC: 2):** In `skill_scorer.py`, refactor `_calculate_market_relevance` to accept a list of years and check against multiple hot skill lists.
  - [x] **Task 3 (AC: 3):** Locate the LLM prompt generation logic in `ai/service.py` and enhance it with instructions to weigh leadership and experience more heavily.
    - **Current Prompt Location:** `backend/app/modules/ai/service.py` lines 271-294 (`_perform_ai_analysis` method)
    - **Current State:** The prompt already extracts `has_leadership` and `total_years` via `experience_breakdown`
    - **Enhancement Required:** Modify the scoring instructions in the prompt to explicitly increase score weighting:
      ```
      SCORING ADJUSTMENTS:
      - If has_leadership is true, add +10 bonus to experience score (cap at 100)
      - For total_years >= 5, add +5 to experience score; >= 10 years add +10
      - Senior-level titles (Director, VP, CTO, Principal) should boost professionalism score
      ```
    - **Alternative Approach:** Instead of modifying the LLM prompt, apply the bonus scoring in Python code after receiving the LLM response (more deterministic)
  - [x] **Task 4 (AC: 9):** Update unit tests for `skill_scorer.py` to validate the new versioned market relevance logic.

- [x] **Backend - Job Match Endpoint**
  - [x] **Task 5 (AC: 4):** In `jobs/router.py`, add the `POST /api/v1/jobs/{job_id}/match` endpoint, protected by the `require_recruiter` guard.
  - [x] **Task 6 (AC: 5):** In `jobs/services.py`, create a new service function that takes a `job_id` and `cv_id`, fetches the necessary data, and uses the existing `SkillMatcher` to calculate a match score.
  - [x] **Task 7 (AC: 9):** Add integration tests for the new `/match` endpoint, covering success, authorization failure, and not-found cases.

- [x] **Frontend - Display Job Match Score**
  - [x] **Task 8 (AC: 6):** In the candidates page (`/jobs/jd/[jdId]/candidates/page.tsx`), update the data fetching logic to call the new `/match` endpoint for each candidate.
    - **Note on N+1 API Calls:** The current approach will make N API calls (one per candidate). This is acceptable for MVP because:
      1. The candidate list is paginated (default 20 per page)
      2. Calls can be made in parallel using `Promise.all()`
      3. The `/match` endpoint is lightweight (no DB writes, just calculation)
    - **Future Optimization:** Consider adding a batch endpoint `POST /api/v1/jobs/{job_id}/match-batch` that accepts `{ "cv_ids": ["id1", "id2", ...] }` if performance becomes an issue.
  - [x] **Task 9 (AC: 7):** In `CandidateCard.tsx`, add a new prop for `jobMatchScore` and display it prominently. Implement the color-coding logic (Green/Yellow/Red).
  - [x] **Task 10 (AC: 8):** Ensure the `CandidateCard.tsx` handles a loading or null state for the `jobMatchScore`.
  - [x] **Task 11 (AC: 10):** Update tests for `CandidateCard.tsx` to verify the new score and its color-coding are displayed correctly.

- [x] **E2E Testing**
  - [x] **Task 12 (AC: 11):** In `frontend/e2e/`, create or update a test file to verify that the job match score appears correctly on the candidate list page.

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- None required - all implementations were already in place

### Completion Notes List
- Most of Story 5.7 was already implemented in the codebase
- Task 11: Added 12 new test cases for Job Match Score display in CandidateCard.test.tsx
- Task 12: Created new E2E test file `job-match-score.spec.ts` with comprehensive Playwright tests
- Backend tests pass: 14 market_relevance tests, 13 match endpoint tests
- Frontend tests pass: 23 CandidateCard tests including 12 new Job Match Score tests

### File List
- `backend/app/modules/ai/skill_taxonomy.py` - HOT_SKILLS_2023, HOT_SKILLS_VERSIONS, is_hot_skill_versioned (existing)
- `backend/app/modules/ai/skill_scorer.py` - _calculate_market_relevance with years param (existing)
- `backend/app/modules/ai/service.py` - _apply_leadership_experience_bonus method (existing)
- `backend/app/modules/jobs/router.py` - POST /jd/{jd_id}/match endpoint (existing)
- `backend/app/modules/jobs/services.py` - calculate_job_match_score function (existing)
- `backend/app/modules/jobs/schemas.py` - JobMatchRequest, JobMatchResponse (existing)
- `backend/tests/modules/ai/test_skill_scorer.py` - Versioned hot skills tests (existing)
- `backend/tests/modules/jobs/test_job_router.py` - TestJobMatchEndpoint class (existing)
- `frontend/features/jobs/components/CandidateCard.tsx` - jobMatchScore prop, color-coding (existing)
- `frontend/features/jobs/components/CandidateList.tsx` - fetchJobMatchScores logic (existing)
- `frontend/features/jobs/actions.ts` - calculateJobMatchAction (existing)
- `frontend/services/job.service.ts` - calculateJobMatch method (existing)
- `packages/shared-types/src/job.ts` - JobMatchRequest, JobMatchResponse types (existing)
- `frontend/features/jobs/components/CandidateCard.test.tsx` - Job Match Score tests (modified)
- `frontend/e2e/job-match-score.spec.ts` - E2E tests for job match score (new)

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-21 | 1.0 | Initial draft of story based on Sprint Change Proposal. | Lem_SM |
| 2025-12-21 | 1.1 | Added Story 5.7 to epic, added Testing section, updated source refs. | Lem_PO |
| 2025-12-22 | 1.2 | Completed implementation - added CandidateCard tests and E2E tests. | Lem_Dev |
