# Story 9.2.2: Skills Filter with Autocomplete

## Status
in-progress

## Parent Story
Story 9.2: Bộ lọc tìm kiếm nâng cao

## Verification
- [ ] Database already has `required_skills` column (Verified: Yes, ARRAY(Text) with GIN index removed in recent migration, need check).
- [ ] Backend endpoint for autocomplete works.
- [ ] Search endpoint supports skill filtering.
- [ ] Frontend autocomplete works with debounce.

## Tasks

### Backend Implementation

- [x] **Task 1: Verify Indexes**
    - [x] Check if `required_skills` has GIN index. Since a recent migration `237e5b73c96b` dropped it (`op.drop_index(...postgreql_using='gin')`), we might need to add it back for performance? 
    - [x] Actually, the migration dropped `ix_job_descriptions_required_skills`. We should probably re-add it for efficient `@>` and `&&` operations.
    - [x] Action: Create migration to add GIN index on `required_skills`.

- [x] **Task 2: Skill Suggestions Service**
    - [x] Create `get_skill_suggestions(keyword: str, limit: int)` function.
    - [x] Logic: Query `required_skills` using `unnest`, `group by`, and `count`.
    - [x] Return schema: `List[SkillSuggestion]` (skill_name, count).

- [x] **Task 3: Skill Autocomplete Endpoint**
    - [x] `GET /api/v1/jobs/skills/autocomplete?q=python`
    - [x] Public endpoint.

- [x] **Task 4: Update Search Service**
    - [x] Update `search_jobs_basic` to accept `skills: List[str]`.
    - [x] Logic: `JobDescription.required_skills.overlap(skills)` (Postgres `&&` operator).

### Frontend Implementation

- [x] **Task 5: Skill Service & Actions**
    - [x] `getSkillSuggestions(query)` in service.
    - [x] `getSkillSuggestionsAction(query)` in actions.
    - [x] Update `searchJobsBasic` to include `skills` param.

- [x] **Task 6: SkillAutocomplete Component**
    - [x] UI: Input field + Dropdown suggestions + Selected tags (badges).
    - [x] Logic: Debounce input (300ms), fetch suggestions, handle selection.

- [x] **Task 7: Integrate into JobSearchPage**
    - [x] Add `skills` state (string array).
    - [x] Sync with URL `?skills=...`.
    - [x] Pass to `SkillAutocomplete` component.

## Technical Notes

### GIN Index Restoration
We need GIN index for efficient array operations.
```sql
CREATE INDEX idx_job_descriptions_required_skills_gin ON job_descriptions USING GIN (required_skills);
```

### Autocomplete Query
```sql
SELECT skill, count(*) 
FROM (
  SELECT unnest(required_skills) as skill 
  FROM job_descriptions 
  WHERE is_active = true
) s
WHERE skill ILIKE :q
GROUP BY skill
ORDER BY count DESC
LIMIT 10
```
