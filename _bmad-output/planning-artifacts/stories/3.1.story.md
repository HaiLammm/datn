# Story 3.1: Job Description Module Foundation

## Status
Done

## Story
**As a** developer,
**I want** JD database models and basic CRUD API,
**So that** JDs can be stored and managed for the Candidate Discovery feature.

## Acceptance Criteria
1. Tao `JobDescription` SQLAlchemy model voi all fields tu schema (id, user_id, title, description, uploaded_at, is_active, required_skills, min_experience_years, location_type, salary_min, salary_max, parsed_requirements, embedding)
2. Tao Alembic migration cho `job_descriptions` table
3. Tao `JobDescriptionCreate`, `JobDescriptionResponse`, `JobDescriptionList` Pydantic schemas
4. Implement CRUD endpoints: POST (create), GET (list), GET (detail by id), DELETE
5. Endpoints protected voi authentication (require logged-in user)
6. Basic validation: title required, description required, location_type must be one of 'remote', 'hybrid', 'on-site'
7. User chi co the xem/xoa JDs cua chinh minh (authorization check)
8. Unit tests cho service layer va router layer

## Tasks / Subtasks

- [x] **Task 1: Create JobDescription SQLAlchemy Model (AC: 1)**
    - [x] Create file `backend/app/modules/jobs/__init__.py`
    - [x] Create file `backend/app/modules/jobs/models.py` with `JobDescription` model
    - [x] Define all fields: id (UUID), user_id (Integer FK), title, description, uploaded_at, is_active, required_skills (ARRAY), min_experience_years, location_type (CHECK constraint), salary_min, salary_max, parsed_requirements (JSONB), embedding (JSONB)
    - [x] Add relationship to User model

- [x] **Task 2: Create Alembic Migration (AC: 2)**
    - [x] Generate migration: `alembic revision --autogenerate -m "add_job_descriptions_table"`
    - [x] Review generated migration file
    - [x] Add indexes: user_id, required_skills (GIN)
    - [x] Run migration: `alembic upgrade head`
    - [x] Verify table created in PostgreSQL

- [x] **Task 3: Create Pydantic Schemas (AC: 3)**
    - [x] Create file `backend/app/modules/jobs/schemas.py`
    - [x] Define `JobDescriptionBase` with common fields
    - [x] Define `JobDescriptionCreate` (title, description required; optional: required_skills, min_experience_years, location_type, salary_min, salary_max)
    - [x] Define `JobDescriptionResponse` with all fields including id, user_id, uploaded_at
    - [x] Define `JobDescriptionList` for list response

- [x] **Task 4: Implement Service Layer (AC: 4, 7)**
    - [x] Create file `backend/app/modules/jobs/services.py`
    - [x] Implement `create_job_description(db, user, data: JobDescriptionCreate) -> JobDescription`
    - [x] Implement `get_job_descriptions_by_user(db, user_id) -> List[JobDescription]`
    - [x] Implement `get_job_description(db, jd_id, user_id) -> JobDescription | None` (with user ownership check)
    - [x] Implement `delete_job_description(db, jd_id, user_id) -> bool` (with user ownership check)

- [x] **Task 5: Implement Router/API Endpoints (AC: 4, 5, 6)**
    - [x] Update file `backend/app/modules/jobs/router.py`
    - [x] Define router with prefix `/jd` (under `/jobs` prefix from api.py)
    - [x] Implement `POST /jobs/jd` - Create new JD (auth required)
    - [x] Implement `GET /jobs/jd` - List user's JDs (auth required)
    - [x] Implement `GET /jobs/jd/{jd_id}` - Get JD detail (auth required, ownership check)
    - [x] Implement `DELETE /jobs/jd/{jd_id}` - Delete JD (auth required, ownership check)
    - [x] Add validation for required fields (title, description)
    - [x] Add validation for location_type enum

- [x] **Task 6: Register Router in Main App (AC: 4)**
    - [x] Jobs router already registered in `backend/app/api/v1/api.py`
    - [x] Router included with prefix `/api/v1/jobs`

- [x] **Task 7: Create Shared TypeScript Types (AC: 3)**
    - [x] Create `packages/shared-types/src/job.ts` with JobDescription interfaces
    - [x] Define `JobDescriptionCreate`, `JobDescriptionResponse` types
    - [x] Export from `packages/shared-types/src/index.ts`

- [x] **Task 8: Write Unit Tests (AC: 8)**
    - [x] Create `backend/tests/modules/jobs/__init__.py`
    - [x] Create `backend/tests/modules/jobs/test_job_service.py`
        - [x] `test_create_job_description_success` - Verify JD created with correct fields
        - [x] `test_create_job_description_minimal_fields` - Verify JD with only required fields
        - [x] `test_get_job_descriptions_by_user_returns_only_users_jds` - Verify returns only user's JDs
        - [x] `test_get_job_descriptions_by_user_empty_list` - Verify empty list when no JDs
        - [x] `test_get_job_description_success` - Verify returns JD when exists
        - [x] `test_get_job_description_not_found` - Verify returns None for non-existent
        - [x] `test_get_job_description_wrong_user` - Verify returns None for other user's JD
        - [x] `test_delete_job_description_success` - Verify successful deletion
        - [x] `test_delete_job_description_not_found` - Verify returns False for non-existent
        - [x] `test_delete_job_description_wrong_user` - Verify cannot delete other's JD
    - [x] Create `backend/tests/modules/jobs/test_job_router.py`
        - [x] `test_create_jd_success` - POST returns 201 with JD data
        - [x] `test_create_jd_missing_title` - POST returns 422 validation error
        - [x] `test_create_jd_missing_description` - POST returns 422 validation error
        - [x] `test_create_jd_invalid_location_type` - POST returns 422 validation error
        - [x] `test_create_jd_unauthenticated` - POST returns 401/403
        - [x] `test_list_jds_success` - GET returns user's JDs
        - [x] `test_list_jds_empty` - GET returns empty list
        - [x] `test_get_jd_detail_success` - GET returns JD detail
        - [x] `test_get_jd_not_found` - GET returns 404
        - [x] `test_get_jd_invalid_uuid` - GET returns 422
        - [x] `test_delete_jd_success` - DELETE returns 204
        - [x] `test_delete_jd_not_found` - DELETE returns 404
        - [x] `test_delete_jd_not_owner` - DELETE returns 404
        - [x] `test_delete_jd_unauthenticated` - DELETE returns 401/403
    - [x] Run all tests: `pytest backend/tests/modules/jobs/ -v` - 24 tests passed

## Dev Notes

### Previous Story Insights
From Epic 2 (CV Analysis):
- The backend follows modular architecture pattern with `router.py`, `service.py`, `schemas.py`, `models.py` per module
- Authentication uses `get_current_user` dependency from `backend/app/modules/auth/dependencies.py`
- Database uses SQLAlchemy async sessions with `get_db` dependency
- Proper transaction handling pattern established (commit, refresh)
- File structure follows `backend/app/modules/{feature}/` pattern

From Story 2.3 (RAG Integration):
- ChromaDB and embeddings are already set up in `backend/app/modules/ai/`
- Embedding model uses 768 dimensions (paraphrase-multilingual-MiniLM-L12-v2)
- Vector storage pattern can be reused for JD embeddings later

### Data Models

**JobDescription Model Schema:**
```python
class JobDescription(Base):
    __tablename__ = "job_descriptions"
    
    id: UUID = Column(UUID, primary_key=True, default=uuid.uuid4)
    user_id: UUID = Column(UUID, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    title: str = Column(String(255), nullable=False)
    description: str = Column(Text, nullable=False)
    uploaded_at: datetime = Column(DateTime, default=datetime.utcnow)
    is_active: bool = Column(Boolean, default=True, nullable=False)
    required_skills: List[str] = Column(ARRAY(Text), nullable=True)
    min_experience_years: int = Column(Integer, nullable=True)
    location_type: str = Column(String(50), nullable=False, default='remote')
    salary_min: int = Column(Integer, nullable=True)
    salary_max: int = Column(Integer, nullable=True)
    parsed_requirements: dict = Column(JSONB, nullable=True)
    embedding = Column(Vector(768), nullable=True)
    
    # Relationship
    user = relationship("User", back_populates="job_descriptions")
```

**[Source: docs/architecture/database-schema.md, docs/architecture/data-models.md]**

### API Specifications

| Method | Endpoint | Description | Auth | Response |
|--------|----------|-------------|------|----------|
| POST | `/api/v1/jobs/jd` | Create new JD | Required | 201 + JD data |
| GET | `/api/v1/jobs/jd` | List user's JDs | Required | 200 + List[JD] |
| GET | `/api/v1/jobs/jd/{jd_id}` | Get JD detail | Required | 200 + JD / 404 |
| DELETE | `/api/v1/jobs/jd/{jd_id}` | Delete JD | Required | 204 / 404 |

**[Source: docs/prd/3-candidate-discovery-epic.md#3.4.2]**

### File Locations

**Files to Create:**
```
backend/app/modules/jobs/
├── __init__.py
├── models.py          # JobDescription SQLAlchemy model
├── schemas.py         # Pydantic schemas
├── service.py         # CRUD business logic
└── router.py          # API endpoints

backend/tests/modules/jobs/
├── __init__.py
├── test_job_service.py
└── test_job_router.py

packages/shared-types/src/
└── job.ts             # Update with JD interfaces
```

**Files to Modify:**
- `backend/app/main.py` - Include jobs router
- `backend/app/modules/users/models.py` - Add job_descriptions relationship (optional)
- `packages/shared-types/src/index.ts` - Export job types

**[Source: docs/architecture/source-tree.md]**

### Technical Constraints

1. **Naming Conventions:**
   - Python: `snake_case` for variables/functions, `PascalCase` for classes
   - Database tables: `snake_case` plural (`job_descriptions`)
   - API routes: `kebab-case` (`/jobs/jd`)

2. **Authentication:**
   - All endpoints must use `Depends(get_current_user)`
   - Never access tokens from client-side JavaScript

3. **Validation:**
   - `location_type` must be one of: `'remote'`, `'hybrid'`, `'on-site'`
   - `title` and `description` are required fields
   - Use Pydantic for input validation

4. **Database:**
   - Use `UUID` for primary keys
   - Add `ON DELETE CASCADE` for user_id foreign key
   - Use `ARRAY(Text)` for required_skills
   - Use `JSONB` for parsed_requirements

**[Source: docs/architecture/coding-standards.md, docs/architecture/backend-architecture.md]**

### Dependencies

- Story 3.1 depends on: Epic 1 (Auth system - already complete)
- Story 3.2 (JD Parsing) depends on this story
- Story 3.3 (Candidate Ranking) depends on this story

## Testing

### Backend Tests
- **Location:** `backend/tests/modules/jobs/`
- **Framework:** `pytest` with async support (`pytest-asyncio`)
- **Test Client:** `httpx.AsyncClient` for API tests
- **Database:** Use test fixtures with isolated database transactions

### Test Patterns

```python
# Example: test_job_router.py
import pytest
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_create_jd_success(
    async_client: AsyncClient, 
    authenticated_user_cookies: dict
):
    response = await async_client.post(
        "/api/v1/jobs/jd",
        json={
            "title": "Senior Python Developer",
            "description": "Looking for experienced Python developer...",
            "location_type": "remote",
            "required_skills": ["Python", "FastAPI", "PostgreSQL"],
            "min_experience_years": 3
        },
        cookies=authenticated_user_cookies
    )
    assert response.status_code == 201
    data = response.json()
    assert data["title"] == "Senior Python Developer"
    assert data["user_id"] is not None

@pytest.mark.asyncio
async def test_create_jd_unauthenticated(async_client: AsyncClient):
    response = await async_client.post(
        "/api/v1/jobs/jd",
        json={"title": "Test", "description": "Test JD"}
    )
    assert response.status_code == 401
```

**[Source: docs/architecture/testing-strategy.md]**

### Mocking Strategy
- Mock database session for unit tests
- Use real database with test fixtures for integration tests
- Mock `get_current_user` for router tests when needed

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-17 | 1.0 | Initial draft of Story 3.1 - Job Description Module Foundation | Bob (Scrum Master) |
| 2025-12-17 | 1.1 | Implementation complete - all tasks done, 24 tests passing | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Anthropic)

### File List

**Created:**
- `backend/app/modules/jobs/models.py` - JobDescription SQLAlchemy model
- `backend/app/modules/jobs/schemas.py` - Pydantic schemas for JD CRUD
- `backend/app/modules/jobs/services.py` - Service layer with CRUD operations
- `backend/app/modules/jobs/router.py` - API endpoints (updated from placeholder)
- `backend/tests/modules/jobs/__init__.py` - Test package init
- `backend/tests/modules/jobs/test_job_service.py` - 10 service layer tests
- `backend/tests/modules/jobs/test_job_router.py` - 14 router/API tests
- `backend/alembic/versions/609a832b1945_add_job_descriptions_table.py` - Migration
- `packages/shared-types/src/job.ts` - TypeScript types for frontend

**Modified:**
- `backend/app/modules/users/models.py` - Added job_descriptions relationship
- `backend/alembic/env.py` - Added JobDescription import for autogenerate
- `packages/shared-types/src/index.ts` - Export job types

### Completion Notes

1. **Embedding Field**: The story specified `Vector(768)` for the embedding field, but the project uses ChromaDB (not pgvector) for vector storage. Implemented as `JSONB` instead, which can store the embedding array. ChromaDB integration for JD embeddings will be done in Story 3.2/3.3.

2. **User ID Type**: The story template showed `user_id` as UUID, but the actual User model uses `Integer` for `id`. Implemented correctly as `Integer` FK.

3. **Router Registration**: The jobs router was already registered in `api.py`, so Task 6 was already complete.

4. **Test Coverage**: Implemented 24 unit tests covering:
   - Service layer: 10 tests for CRUD operations and authorization
   - Router layer: 14 tests for all endpoints, validation, and auth

5. **All 259 backend tests pass** with no regressions.

### Debug Log References
N/A - No significant debugging issues encountered.
