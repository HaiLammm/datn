# Story 8.1: Thiết lập Phòng Phỏng vấn Ảo (Virtual Interview Room Setup)

Status: done

## Story

As a người tìm việc (Job Seeker),
I want để tạo một phòng phỏng vấn ảo cho một vị trí công việc cụ thể hoặc sử dụng CV đã tải lên,
So that AI có thể tạo ra các câu hỏi phỏng vấn phù hợp và cá nhân hóa.

## Acceptance Criteria

1.  **Given** tôi đã đăng nhập với role "job_seeker", **When** tôi cung cấp mô tả công việc (JD) hoặc chọn một CV đã tải lên, **Then** hệ thống tạo một phiên phỏng vấn mới với các câu hỏi phỏng vấn được cá nhân hóa bởi AI. (Covers FR14)
2.  **Given** tôi không cung cấp đủ thông tin (không có JD và không có CV), **When** tôi cố gắng tạo phòng phỏng vấn, **Then** hệ thống yêu cầu bổ sung thông tin hoặc đề xuất các lựa chọn mặc định.
3.  **And** tôi có thể xem trước các chủ đề hoặc loại câu hỏi sẽ được hỏi trước khi bắt đầu.
4.  **And** tôi có thể thiết lập các thông số cơ bản cho buổi phỏng vấn (ví dụ: thời lượng, số lượng câu hỏi, độ khó).

## Tasks / Subtasks

- [x] **Backend: Implement QuestionService & API** (AC 1, 2)
    - [x] Create `QuestionService` in `app/modules/interviews/services.py` (or similar).
    - [x] Integrate with existing `_sub-agents/agents/question_generator.py` (`QuestionCraft AI`).
    - [x] Implement `POST /api/v1/interviews/generate-questions`.
        - Input: `job_description`, `cv_content` (optional), `position_level` (optional), `config` (num_questions, focus_areas).
        - Logic: Call AI agent to generate questions.
        - Output: JSON array of questions with evaluation criteria.
    - [x] Save generated questions to `interview_questions` table and create a new `interview_session` record in DB.
    - [x] Handle errors from AI agent (timeout, failure) gracefully.

- [x] **Frontend: Create Interview Setup UI** (AC 1, 2, 4)
    - [x] Create "Interview Setup" page (`/interviews/new` or modal).
    - [x] Implement form to:
        - Paste Job Description text or upload file (reuse JD parsing logic if needed or just raw text).
        - Select from uploaded CVs (fetch list from CV module).
        - Configure options: Difficulty (Junior/Mid/Senior), Number of questions (5/10/15).
    - [x] Validation: Ensure at least JD or CV is provided.

- [x] **Frontend: Interview Preview & Start** (AC 3)
    - [x] Display loading state while AI generates questions ("Preparing your interview room...").
    - [x] Show preview of generated interview (e.g., "Interview for [Role]", "10 Questions", "Focus: React, Node.js").
    - [x] "Start Interview" button to navigate to the active interview room (`/interviews/[id]/room`).

- [x] **Integration Testing**
    - [x] Verify `QuestionService` correctly invokes `QuestionGeneratorAgent`.
    - [x] Verify questions are saved to DB and associated with the session.

## Dev Notes

- **AI Agent Integration:**
    - The AI agent is ALREADY implemented in `_sub-agents/agents/question_generator.py`.
    - **DO NOT Re-implement the agent.**
    - Import and use `QuestionGeneratorAgent` class.
    - Configuration file: `_sub-agents/configs/question_generator_config.json`.
    - Check `_sub-agents/INTEGRATION_GUIDE.md` (if exists) or `README.md` for usage details.

- **Architecture Compliance:**
    - **Module:** `app/modules/interviews/` (New module likely needed).
    - **Service Layer:** Logic must reside in `services.py`, not controllers.
    - **Database:** Use `interview_sessions` and `interview_questions` tables (Schema should be defined in `app/modules/interviews/models.py`). Ensure migrations are applied if new tables are needed.

- **Tech Stack:**
    - Backend: FastAPI, SQLAlchemy (or similar ORM used in project), Python 3.x.
    - Frontend: Next.js 14+ (App Router), Tailwind CSS, Shadcn UI (if used).
    - AI: Ollama (Local), `Llama-3.2-3B-Instruct`.

- **References:**
    - `_sub-agents/agents/question_generator.py` (Source code for agent)
    - Epic 8 in `_bmad-output/planning-artifacts/epics.md`
    - `backend-architecture.md` (Service layer patterns)

## Dev Agent Record

### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- [Epic 8 Definition](file:///home/luonghailam/Projects/datn/_bmad-output/planning-artifacts/epics.md#L187)
- [Story 8.1 Definition](file:///home/luonghailam/Projects/datn/_bmad-output/planning-artifacts/epics.md#L275)
