# Story 9.2.1: Salary Range & Job Type Filters

## Status
ready-for-dev

## Parent Story
Story 9.2: Bộ lọc tìm kiếm nâng cao (Split into 3 sub-stories)

## Story
**As a** Job Seeker (Người tìm việc),
**I want** to filter job search results by salary range and job type (full-time/part-time/contract),
**So that** I can find jobs that match my salary expectations and preferred employment type.

## Acceptance Criteria

### AC1: Salary Range Filter
**Given** I am on the job search page,
**When** I set a salary range filter (e.g., min: 1000, max: 3000 USD),
**Then** the system filters job descriptions where:
- Job's salary range overlaps with my desired range
- Only jobs with salary information are shown
**And** the filter persists when I navigate between pages.

### AC2: Job Type Filter
**Given** I am on the job search page,
**When** I select one or more job types (e.g., "Full-time", "Part-time", "Contract"),
**Then** the system returns only jobs where `job_type` matches one of the selected types,
**And** I can select multiple job types simultaneously (OR logic).

### AC3: Combined with Basic Search
**Given** I have entered keyword/location from Story 9.1,
**When** I apply salary and job type filters,
**Then** the system applies ALL filters together and displays matching results.

## Tasks / Subtasks

### Backend Implementation

- [ ] **Task 1: Database Schema Enhancement**
    - [ ] Check if columns already exist in `job_descriptions` table
    - [ ] Create migration to add new columns:
        ```sql
        ALTER TABLE job_descriptions
        ADD COLUMN IF NOT EXISTS salary_min INTEGER,
        ADD COLUMN IF NOT EXISTS salary_max INTEGER,
        ADD COLUMN IF NOT EXISTS job_type VARCHAR(50) 
            CHECK (job_type IN ('full-time', 'part-time', 'contract', 'internship', 'freelance'));
        ```
    - [ ] Add indexes for performance:
        ```sql
        CREATE INDEX IF NOT EXISTS idx_job_descriptions_salary 
            ON job_descriptions(salary_min, salary_max);
        CREATE INDEX IF NOT EXISTS idx_job_descriptions_job_type 
            ON job_descriptions(job_type);
        ```
    - [ ] Update `JobDescription` model in `backend/app/modules/jobs/models.py`

- [ ] **Task 2: Update Schemas**
    - [ ] Extend `BasicJobSearchRequest` schema to include:
        - `min_salary: Optional[int]`
        - `max_salary: Optional[int]`
        - `job_types: Optional[List[str]]`
    - [ ] Add salary validation (max >= min)
    - [ ] Update `BasicJobSearchItemResponse` to include:
        - `job_type: Optional[str]`
        - `salary_min: Optional[int]`
        - `salary_max: Optional[int]`

- [ ] **Task 3: Enhance Search Service**
    - [ ] Update `search_jobs_basic()` in `backend/app/modules/jobs/services.py`:
        - Add salary range filter with overlap logic
        - Add job type filter (OR logic for multiple types)
        - Maintain backward compatibility with Story 9.1

- [ ] **Task 4: Update API Endpoint**
    - [ ] Extend `GET /api/v1/jobs/search/basic` to accept:
        - `min_salary` query param
        - `max_salary` query param
        - `job_types` query param (array)
    - [ ] Update response to include new fields

- [ ] **Task 5: Testing**
    - [ ] Test salary range filter
    - [ ] Test job type filter (single and multiple)
    - [ ] Test combined filters with keyword/location
    - [ ] Test backward compatibility (old queries still work)

### Frontend Implementation

- [ ] **Task 6: Update Service & Actions**
    - [ ] Update `searchJobsBasic()` in `services/job.service.ts` to accept new params
    - [ ] Update `searchJobsBasicAction()` in `features/jobs/actions.ts`

- [ ] **Task 7: Create Salary & Job Type Filter UI**
    - [ ] Create `SalaryJobTypeFilters.tsx` component with:
        - Two number inputs for min/max salary
        - Checkboxes for job types
        - Apply/Clear buttons
    - [ ] Add to job search page

- [ ] **Task 8: Update JobCard Component**
    - [ ] Display salary range if available
    - [ ] Display job type badge

- [ ] **Task 9: URL State Management**
    - [ ] Persist salary and job type filters in URL params
    - [ ] Restore filters from URL on page load

## Technical Notes

### Database Migration
```sql
-- Migration: add_salary_and_job_type_to_job_descriptions
-- Check existing columns first to avoid errors

DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name='job_descriptions' AND column_name='salary_min') THEN
        ALTER TABLE job_descriptions ADD COLUMN salary_min INTEGER;
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name='job_descriptions' AND column_name='salary_max') THEN
        ALTER TABLE job_descriptions ADD COLUMN salary_max INTEGER;
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name='job_descriptions' AND column_name='job_type') THEN
        ALTER TABLE job_descriptions 
        ADD COLUMN job_type VARCHAR(50) 
        CHECK (job_type IN ('full-time', 'part-time', 'contract', 'internship', 'freelance'));
    END IF;
END $$;

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_job_descriptions_salary 
    ON job_descriptions(salary_min, salary_max);
CREATE INDEX IF NOT EXISTS idx_job_descriptions_job_type 
    ON job_descriptions(job_type);
```

### Salary Range Overlap Logic
```python
# User wants: $1000 - $3000
# Match jobs where salary range overlaps:
if min_salary is not None or max_salary is not None:
    if min_salary and max_salary:
        # Both specified - check overlap
        query = query.where(
            or_(
                and_(
                    JobDescription.salary_min.isnot(None),
                    JobDescription.salary_max.isnot(None),
                    JobDescription.salary_max >= min_salary,
                    JobDescription.salary_min <= max_salary
                )
            )
        )
    elif min_salary:
        # Only min specified
        query = query.where(
            or_(
                JobDescription.salary_max >= min_salary,
                JobDescription.salary_min >= min_salary
            )
        )
    elif max_salary:
        # Only max specified
        query = query.where(
            JobDescription.salary_min <= max_salary
        )
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Database migration created and tested
- [ ] Backend tests passing
- [ ] Frontend UI working correctly
- [ ] Filters persist in URL
- [ ] Backward compatible with Story 9.1
- [ ] Code reviewed
- [ ] Manual testing completed

## Files to Create/Modify

**Backend:**
- `backend/app/modules/jobs/models.py` - Update JobDescription model
- `backend/app/modules/jobs/schemas.py` - Update schemas
- `backend/app/modules/jobs/services.py` - Update search_jobs_basic()
- `backend/app/modules/jobs/router.py` - Update endpoint
- `backend/alembic/versions/xxx_add_salary_job_type.py` - NEW migration
- `backend/tests/test_jobs_basic_search.py` - Add tests

**Frontend:**
- `frontend/services/job.service.ts` - Update service
- `frontend/features/jobs/actions.ts` - Update actions
- `frontend/features/jobs/components/SalaryJobTypeFilters.tsx` - NEW component
- `frontend/features/jobs/components/JobCard.tsx` - Update to show new fields
- `frontend/app/jobs/find/page.tsx` - Integrate new filters

## Estimated Time
2-3 hours

## Next Steps
After completing 9.2.1:
- Story 9.2.2: Skills Filter with Autocomplete
- Story 9.2.3: Benefits Filter & Active Filter Tags
