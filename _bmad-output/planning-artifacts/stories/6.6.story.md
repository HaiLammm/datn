# Story 6.6: User Statistics API

## Status
Done

## Story
**As a** developer,
**I want** a user statistics endpoint,
**So that** the frontend can display user progress and comprehensive stats without fetching all CVs.

## Acceptance Criteria

1. Tao endpoint `GET /api/v1/users/me/stats` tra ve user statistics
2. Return total CVs uploaded by user
3. Return average quality score across all completed analyses
4. Return best (highest) quality score
5. Return total unique skills across all CVs
6. Return most common skills (top 5)
7. Endpoint phai protected, chi authenticated users moi truy cap duoc
8. Response time phai < 500ms cho user co < 100 CVs

**Dependencies:**
- Existing CV module (Epic 2) - Done
- CVAnalysis model with quality_score, extracted_skills - Done

**Out of Scope:**
- Caching results (can add later for performance)
- Skill trend analysis over time

## Tasks / Subtasks

- [x] **Task 1: Create UserStats schema (AC: 1-6)**
  - [x] Create `backend/app/modules/users/schemas.py` - Add `UserStatsResponse` schema
  - [x] Define fields: total_cvs, average_score, best_score, total_unique_skills, top_skills
  - [x] Add proper type annotations and validation

- [x] **Task 2: Create get_user_stats service function (AC: 2-6, 8)**
  - [x] Add function to `backend/app/modules/users/services.py`
  - [x] Query CVs and CVAnalysis for the user
  - [x] Calculate total CVs count
  - [x] Calculate average score from CVAnalysis records with COMPLETED status
  - [x] Find best (max) quality score
  - [x] Aggregate extracted_skills from all analyses
  - [x] Count skill occurrences and return top 5
  - [x] Use eager loading with `selectinload` to avoid N+1 queries
  - [x] Handle edge cases: no CVs, no completed analyses

- [x] **Task 3: Create /users/me/stats endpoint (AC: 1, 7)**
  - [x] Add new route to `backend/app/modules/users/router.py`
  - [x] Use `get_current_active_user` dependency for authentication
  - [x] Call service function and return UserStatsResponse
  - [x] Add proper docstring for OpenAPI documentation

- [x] **Task 4: Add UserStats TypeScript interface (AC: 1-6)**
  - [x] Add `UserStats` interface to `packages/shared-types/src/user.ts`
  - [x] Export from `packages/shared-types/src/index.ts`
  - [x] Fields: totalCvs, averageScore, bestScore, totalUniqueSkills, topSkills

- [x] **Task 5: Unit Tests for get_user_stats service (AC: 2-6, 8)**
  - [x] Create `backend/tests/modules/users/test_user_stats_service.py`
  - [x] Test: Returns correct total CVs count
  - [x] Test: Calculates average score correctly (only COMPLETED analyses)
  - [x] Test: Returns best score correctly
  - [x] Test: Aggregates unique skills correctly
  - [x] Test: Returns top 5 skills by frequency
  - [x] Test: Handles user with no CVs (returns zeros/empty)
  - [x] Test: Handles user with CVs but no completed analyses
  - [x] Test: Handles CVs with null extracted_skills

- [x] **Task 6: Integration Tests for /users/me/stats endpoint (AC: 1, 7)**
  - [x] Create `backend/tests/modules/users/test_user_stats_router.py`
  - [x] Test: Returns 200 with valid stats for authenticated user
  - [x] Test: Returns 401 for unauthenticated request
  - [x] Test: Returns correct data structure (schema validation)
  - [x] Test: Returns empty stats for new user (no CVs)

- [ ] **Task 7: Update DashboardStats to use API (Optional Enhancement)**
  - [ ] Create `frontend/services/user.service.ts` with `getUserStats()` function
  - [ ] This is optional - Story 6.4 has working fallback calculation
  - [ ] Can be used by Story 6.5 Profile Page

## Dev Notes

### Previous Story Insights (Story 6.4)

**Story 6.4** implemented a fallback calculation for stats directly from CV list:

```typescript
// frontend/features/dashboard/components/DashboardStats.tsx
function calculateStats(cvs: CVWithStatus[]): StatsData {
  const completedCvs = cvs.filter((cv) => cv.quality_score !== null);
  const scores = completedCvs.map((cv) => cv.quality_score!);

  return {
    totalCvs: cvs.length,
    averageScore:
      scores.length > 0
        ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
        : null,
    bestScore: scores.length > 0 ? Math.max(...scores) : null,
  };
}
```

This story provides a dedicated API endpoint that:
1. Moves calculation to backend (more efficient)
2. Adds skill statistics not available from CV list
3. Prepares for caching in future

[Source: docs/stories/6.4.story.md, frontend/features/dashboard/components/DashboardStats.tsx]

### Data Models

**User Model:**
```python
# backend/app/modules/users/models.py
class User(Base):
    __tablename__ = "users"
    id: Mapped[int]              # Integer primary key
    email: Mapped[str]
    role: Mapped[str]            # job_seeker, recruiter, admin
    # ... other fields
    cvs = relationship("CV", back_populates="owner")
```

**CV Model:**
```python
# backend/app/modules/cv/models.py
class CV(Base):
    __tablename__ = "cvs"
    id: Mapped[uuid.UUID]
    user_id: Mapped[int]         # FK to users.id
    filename: Mapped[str]
    uploaded_at: Mapped[datetime]
    is_active: Mapped[bool]
    analyses = relationship("CVAnalysis", back_populates="cv")
```

**CVAnalysis Model:**
```python
# backend/app/modules/ai/models.py
class CVAnalysis(Base):
    __tablename__ = "cv_analyses"
    id: Mapped[uuid.UUID]
    cv_id: Mapped[uuid.UUID]     # FK to cvs.id
    status: Mapped[AnalysisStatus]  # PENDING, PROCESSING, COMPLETED, FAILED
    ai_score: Mapped[int | None]    # Quality score (0-100)
    extracted_skills: Mapped[list[str] | None]  # JSON array of skills
    # Skill breakdown fields (from Story 5.3)
    skill_breakdown: Mapped[dict | None]
    skill_categories: Mapped[dict | None]
```

[Source: backend/app/modules/users/models.py, backend/app/modules/cv/models.py, backend/app/modules/ai/models.py]

### API Specifications

**New Endpoint:**
```
GET /api/v1/users/me/stats
Authorization: Required (access_token cookie)
Response: 200 OK
```

**Response Schema:**
```python
class UserStatsResponse(BaseModel):
    total_cvs: int
    average_score: Optional[float] = None  # null if no completed analyses
    best_score: Optional[int] = None       # null if no completed analyses
    total_unique_skills: int
    top_skills: List[str]                  # Top 5 most common skills

    class Config:
        from_attributes = True
```

**TypeScript Interface:**
```typescript
// packages/shared-types/src/user.ts
export interface UserStats {
  total_cvs: number;
  average_score: number | null;
  best_score: number | null;
  total_unique_skills: number;
  top_skills: string[];
}
```

[Source: docs/prd/6-job-seeker-ux-epic.md:199-211, docs/architecture/backend-architecture.md]

### File Locations

**Files to Modify:**
- `backend/app/modules/users/schemas.py` - Add UserStatsResponse
- `backend/app/modules/users/services.py` - Add get_user_stats function
- `backend/app/modules/users/router.py` - Add /me/stats endpoint
- `packages/shared-types/src/user.ts` - Add UserStats interface
- `packages/shared-types/src/index.ts` - Export UserStats

**Files to Create:**
- `backend/tests/modules/users/test_user_stats_service.py` - Service unit tests
- `backend/tests/modules/users/test_user_stats_router.py` - Router integration tests

**Optional Files:**
- `frontend/services/user.service.ts` - Frontend service (if updating dashboard)

[Source: docs/architecture/source-tree.md, docs/architecture/coding-standards.md]

### Technical Implementation Details

**Service Function Pattern:**
```python
# backend/app/modules/users/services.py
from sqlalchemy.orm import selectinload
from sqlalchemy import select, func
from collections import Counter

async def get_user_stats(db: AsyncSession, user_id: int) -> dict:
    # Query CVs with their analyses using eager loading
    result = await db.execute(
        select(CV)
        .options(selectinload(CV.analyses))
        .where(CV.user_id == user_id, CV.is_active == True)
    )
    cvs = result.scalars().all()
    
    total_cvs = len(cvs)
    
    # Collect scores from COMPLETED analyses
    scores = []
    all_skills = []
    for cv in cvs:
        for analysis in cv.analyses:
            if analysis.status == AnalysisStatus.COMPLETED:
                if analysis.ai_score is not None:
                    scores.append(analysis.ai_score)
                if analysis.extracted_skills:
                    all_skills.extend(analysis.extracted_skills)
    
    # Calculate stats
    average_score = round(sum(scores) / len(scores), 1) if scores else None
    best_score = max(scores) if scores else None
    
    # Unique skills and top 5
    unique_skills = set(all_skills)
    skill_counts = Counter(all_skills)
    top_skills = [skill for skill, _ in skill_counts.most_common(5)]
    
    return {
        "total_cvs": total_cvs,
        "average_score": average_score,
        "best_score": best_score,
        "total_unique_skills": len(unique_skills),
        "top_skills": top_skills,
    }
```

**Router Pattern:**
```python
# backend/app/modules/users/router.py
from app.modules.auth.dependencies import get_current_active_user
from app.modules.users import services, schemas

@router.get("/me/stats", response_model=schemas.UserStatsResponse)
async def get_current_user_stats(
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_active_user),
) -> Any:
    """
    Get statistics for the current user's CVs and analyses.
    """
    stats = await services.get_user_stats(db, current_user.id)
    return stats
```

[Source: docs/architecture/backend-architecture.md, docs/architecture/coding-standards.md:13-105]

### SQLAlchemy Async Considerations

Per coding standards, use eager loading to avoid MissingGreenlet errors:

```python
# CORRECT - Eager loading with selectinload
result = await db.execute(
    select(CV)
    .options(selectinload(CV.analyses))
    .where(CV.user_id == user_id)
)

# WRONG - Would cause lazy loading error
cv.analyses  # Error after session expires
```

[Source: docs/architecture/coding-standards.md:13-105]

### Testing

### Test Framework and Location
- **Unit Tests:** Pytest in `backend/tests/modules/users/`
- **Run Tests:** `cd backend && pytest tests/modules/users/ -v`

[Source: docs/architecture/testing-strategy.md]

### Test Scenarios Required

**test_user_stats_service.py:**
1. User with multiple CVs and completed analyses - returns correct counts
2. User with CVs but no completed analyses - returns null scores
3. User with no CVs - returns zeros and empty arrays
4. Correctly calculates average score (rounded to 1 decimal)
5. Correctly identifies best (max) score
6. Correctly aggregates unique skills across all CVs
7. Returns top 5 skills by frequency (not alphabetically)
8. Handles CVs with null extracted_skills gracefully

**test_user_stats_router.py:**
1. GET /users/me/stats returns 200 for authenticated user
2. GET /users/me/stats returns 401 for unauthenticated request
3. Response matches UserStatsResponse schema
4. Returns empty stats structure for new user

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-19 | 1.0 | Initial draft - User Statistics API story | Lem_SM (Scrum Master) |
| 2025-12-19 | 1.1 | PO Validation passed - Status updated to Approved | Lem_PO (Product Owner) |
| 2025-12-19 | 1.2 | Implementation complete - Tasks 1-6 done, all tests pass | Lem_Dev (Developer) |
| 2025-12-19 | 1.3 | QA Review PASS - Gate created, status updated to Done | Lem_QA (Test Architect) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) via OpenCode

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes List
- Implemented `UserStatsResponse` schema in `backend/app/modules/users/schemas.py`
- Created `get_user_stats` service function with eager loading (selectinload) to avoid N+1 queries
- Added `/me/stats` endpoint to user router with proper authentication
- Added `UserStats` TypeScript interface to shared-types package
- Created comprehensive unit tests (9 test cases) covering all edge cases
- Created integration tests (5 test cases) for endpoint validation
- All 14 tests pass successfully
- Task 7 (Optional frontend integration) skipped - Story 6.4 has working fallback calculation

### File List
**Modified:**
- `backend/app/modules/users/schemas.py` - Added UserStatsResponse schema
- `backend/app/modules/users/services.py` - Added get_user_stats function
- `backend/app/modules/users/router.py` - Added /me/stats endpoint
- `packages/shared-types/src/user.ts` - Added UserStats interface

**Created:**
- `backend/tests/modules/users/__init__.py` - Test module init
- `backend/tests/modules/users/test_user_stats_service.py` - Service unit tests (9 tests)
- `backend/tests/modules/users/test_user_stats_router.py` - Router integration tests (5 tests)

---

## QA Results

### Review Date: 2025-12-19

### Reviewed By: Lem_QA (Test Architect)

### Code Quality Assessment

**Overall: Excellent Implementation**

The implementation demonstrates solid engineering practices:
- Clean separation of concerns (schema, service, router pattern)
- Proper async/await handling with SQLAlchemy
- Eager loading with `selectinload` to avoid N+1 queries
- Comprehensive test coverage with edge cases
- Follows coding standards for TypeScript type sharing

### Requirements Traceability

| AC | Description | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Endpoint `GET /api/v1/users/me/stats` | `test_returns_200_for_authenticated_user` | PASS |
| 2 | Return total CVs | `test_returns_correct_total_cvs_count` | PASS |
| 3 | Return average score | `test_calculates_average_score_correctly`, `test_rounds_average_to_one_decimal` | PASS |
| 4 | Return best score | `test_returns_best_score_correctly` | PASS |
| 5 | Return unique skills count | `test_aggregates_unique_skills_correctly` | PASS |
| 6 | Return top 5 skills | `test_returns_top_5_skills_by_frequency` | PASS |
| 7 | Protected endpoint | `test_returns_401_for_unauthenticated_request` | PASS |
| 8 | Response time < 500ms | Uses eager loading, not load tested | CONCERNS |

### Refactoring Performed

No refactoring needed - implementation follows best practices.

### Compliance Check

- Coding Standards: PASS - Follows SQLAlchemy async rules, uses eager loading
- Project Structure: PASS - Files in correct module locations
- Testing Strategy: PASS - Unit + integration tests with proper mocking
- All ACs Met: PASS - All 8 acceptance criteria implemented

### Improvements Checklist

- [x] Proper eager loading with `selectinload` (services.py:62)
- [x] User ID stored before session operations (router.py:39)
- [x] Comprehensive edge case tests (no CVs, no analyses, null skills)
- [x] TypeScript interface in shared-types package
- [ ] AC 8 (Response time < 500ms) not explicitly tested - recommend adding performance test for users with 100 CVs
- [ ] Consider using `model_config = ConfigDict(from_attributes=True)` instead of deprecated `class Config` in schemas.py:69

### Security Review

- **Authentication**: PASS - Uses `get_current_active_user` dependency
- **Authorization**: PASS - Users can only access their own stats via `current_user.id`
- **Data Exposure**: PASS - Returns only aggregate statistics, no PII exposure

### Performance Considerations

- **Query Efficiency**: PASS - Single query with eager loading, avoids N+1
- **Memory**: CONCERNS - For users with many CVs, loading all CVs into memory could be suboptimal
- **Future Optimization**: The story correctly identifies caching as out of scope for future enhancement

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** -> docs/qa/gates/6.6-user-statistics-api.yml

### Recommended Status

**Ready for Done**

Minor concerns noted (Pydantic deprecation warning, no explicit performance test), but these are non-blocking. The implementation is solid, well-tested, and follows all coding standards.
