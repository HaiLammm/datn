# Risk Profile: Story 5.3

**Story Title:** Database Schema & API Response Update  
**Date:** 2024-12-16  
**Reviewer:** Quinn (Test Architect)

## Executive Summary

| Metric | Value |
|--------|-------|
| Total Risks Identified | 3 |
| Critical Risks | 0 |
| High Risks | 0 |
| Medium Risks | 1 |
| Low Risks | 2 |
| **Risk Score** | **93/100** (Low Risk) |

This story represents a **low-risk database schema update**. No security, authentication, or critical business logic is affected. The primary risks relate to migration management and future schema evolution.

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| DATA-001 | Migration rollback in production with existing data | Low (1) | Medium (2) | 2 | Low |
| TECH-001 | JSONB schema drift between TypedDict and Pydantic | Medium (2) | Low (1) | 2 | Low |
| OPS-001 | Migration ordering conflicts with parallel development | Medium (2) | Medium (2) | 4 | Medium |

## Detailed Risk Analysis

### OPS-001: Migration Ordering Conflicts (Score: 4 - Medium)

**Category:** Operational  
**Probability:** Medium (2) - Multiple developers may create migrations concurrently  
**Impact:** Medium (2) - Could cause deployment failures or require migration fixes

**Description:**  
The migration `f7a3b2c1d4e5` depends on `e501602af441`. If another developer creates a migration with the same parent, Alembic will detect a branch conflict during deployment.

**Affected Components:**
- `backend/alembic/versions/f7a3b2c1d4e5_add_skill_breakdown_columns.py`
- Alembic migration chain

**Mitigation Strategy:** Preventive
| Action | Owner | Timeline |
|--------|-------|----------|
| Run `alembic heads` before merging to detect conflicts | dev | Pre-merge |
| Use `alembic merge` if branches detected | dev | As needed |
| Document migration dependencies in PR description | dev | Each PR |

**Testing Requirements:**
- Verify `alembic upgrade head` succeeds in CI pipeline
- Run `alembic history` to confirm linear chain

**Residual Risk:** Low - Standard Alembic workflow handles this

---

### DATA-001: Migration Rollback with Existing Data (Score: 2 - Low)

**Category:** Data  
**Probability:** Low (1) - Rollbacks in production are rare  
**Impact:** Medium (2) - Data in new columns would be lost on rollback

**Description:**  
If production data exists in `skill_breakdown`, `skill_categories`, or `skill_recommendations` columns and the migration is rolled back, that data will be permanently lost.

**Affected Components:**
- `cv_analyses` table
- `skill_breakdown`, `skill_categories`, `skill_recommendations` columns

**Mitigation Strategy:** Preventive + Corrective
| Action | Owner | Timeline |
|--------|-------|----------|
| Backup database before any rollback | ops | Pre-rollback |
| Story 5.4 should populate columns before heavy usage | dev | Story 5.4 |
| Add rollback warning in migration docstring | dev | Done |

**Testing Requirements:**
- Migration rollback tested in Dev Notes (verified)
- No production data exists yet (new columns)

**Residual Risk:** Minimal - Columns are new, no existing data to lose

---

### TECH-001: JSONB Schema Drift (Score: 2 - Low)

**Category:** Technical  
**Probability:** Medium (2) - Schema may evolve over time  
**Impact:** Low (1) - Pydantic validation catches mismatches

**Description:**  
The `SkillScoreResult` TypedDict (Story 5.2) and `SkillBreakdown` Pydantic schema (Story 5.3) must stay synchronized. If `SkillScorer` is updated without updating the Pydantic schema, API responses may be inconsistent.

**Affected Components:**
- `backend/app/modules/ai/skill_scorer.py` - `SkillScoreResult` TypedDict
- `backend/app/modules/ai/schemas.py` - `SkillBreakdown`, `SkillCategories`

**Mitigation Strategy:** Detective
| Action | Owner | Timeline |
|--------|-------|----------|
| Type hints ensure compile-time detection | dev | Ongoing |
| Integration tests in Story 5.4 will validate end-to-end | dev | Story 5.4 |
| Consider consolidating TypedDict and Pydantic schema | dev | Future |

**Testing Requirements:**
- `test_analysis_result_skill_breakdown_from_dict` validates dictâ†’Pydantic flow
- Story 5.4 integration tests will validate full pipeline

**Residual Risk:** Low - Pydantic validation provides runtime safety net

---

## Risk Distribution

### By Category

| Category | Count | Critical | High | Medium | Low |
|----------|-------|----------|------|--------|-----|
| Technical (TECH) | 1 | 0 | 0 | 0 | 1 |
| Security (SEC) | 0 | 0 | 0 | 0 | 0 |
| Performance (PERF) | 0 | 0 | 0 | 0 | 0 |
| Data (DATA) | 1 | 0 | 0 | 0 | 1 |
| Business (BUS) | 0 | 0 | 0 | 0 | 0 |
| Operational (OPS) | 1 | 0 | 0 | 1 | 0 |

### By Component

| Component | Risk Count |
|-----------|------------|
| Backend (Database) | 2 |
| Backend (Migrations) | 1 |
| Frontend | 0 |
| Infrastructure | 0 |

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests (OPS-001)

| Test Scenario | Type | Status |
|---------------|------|--------|
| Migration upgrade succeeds | Integration | Verified in Dev Notes |
| Migration downgrade succeeds | Integration | Verified in Dev Notes |
| Migration re-upgrade succeeds | Integration | Verified in Dev Notes |
| No Alembic branch conflicts | CI Check | Recommended |

### Priority 2: Low Risk Tests (DATA-001, TECH-001)

| Test Scenario | Type | Status |
|---------------|------|--------|
| Existing records without new columns work | Unit | `test_cv_analysis_without_new_columns_backward_compatible` |
| Dict coercion to Pydantic schemas | Unit | `test_analysis_result_skill_breakdown_from_dict` |
| SkillBreakdown field validation | Unit | 11 tests in `TestSkillBreakdown` |

## Risk Acceptance Criteria

### Must Fix Before Production

None - No critical or high risks identified.

### Can Deploy with Mitigation

| Risk | Mitigation | Status |
|------|------------|--------|
| OPS-001 | Run `alembic heads` in CI | Recommended |

### Accepted Risks

| Risk | Reason | Accepted By |
|------|--------|-------------|
| DATA-001 | New columns, no data to lose | Quinn (QA) |
| TECH-001 | Pydantic validation catches mismatches | Quinn (QA) |

## Monitoring Requirements

No special monitoring required for this story. Standard database monitoring applies.

| Metric | Threshold | Alert |
|--------|-----------|-------|
| Migration duration | > 30s | Warning |
| JSONB column size | > 10KB avg | Info |

## Risk Review Triggers

Review and update this risk profile when:

- [ ] Story 5.4 (AI Service Integration) is implemented
- [ ] `SkillScoreResult` TypedDict structure changes
- [ ] New skill categories are added to taxonomy
- [ ] Production rollback is considered

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 1
    low: 2
  highest:
    id: OPS-001
    score: 4
    title: "Migration ordering conflicts with parallel development"
  recommendations:
    must_fix: []
    monitor:
      - "Run alembic heads in CI to detect branch conflicts"
      - "Validate migration chain before production deployment"
```

---

**Risk profile:** `docs/qa/assessments/5.3-risk-20241216.md`
